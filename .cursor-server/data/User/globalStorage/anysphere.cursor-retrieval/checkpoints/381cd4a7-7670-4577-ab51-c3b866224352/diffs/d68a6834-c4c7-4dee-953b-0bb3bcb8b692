{"fsPath":"\\home\\oxetech_mcz\\app\\api\\edu\\route.ts","fileUuid":"d68a6834-c4c7-4dee-953b-0bb3bcb8b692","fileSizeBytes":2916,"numLines":116,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":117,"addedLines":["import { NextResponse } from 'next/server'","import { prisma } from '@/lib/db'","","export const dynamic = 'force-dynamic'","","export async function GET() {","  try {","    // Frequência por escola","    const escolas = await prisma.escolas_oxetech_edu.findMany({","      select: {","        id: true,","        nome: true,","        matriculas_oxetech_edu: {","          select: {","            id: true,","            faltas: true,","            inscricoes_turmas_oxetech_edu: {","              select: {","                presente: true,","              },","            },","          },","        },","      },","    })","","    const frequenciaPorEscola = escolas.map((escola) => {","      const totalPresencas = escola.matriculas_oxetech_edu.reduce(","        (acc, matricula) =>","          acc +","          matricula.inscricoes_turmas_oxetech_edu.filter((i) => i.presente)","            .length,","        0","      )","      const totalAulas = escola.matriculas_oxetech_edu.reduce(","        (acc, matricula) =>","          acc + matricula.inscricoes_turmas_oxetech_edu.length,","        0","      )","","      return {","        escola: escola.nome,","        frequencia:","          totalAulas > 0 ? (totalPresencas / totalAulas) * 100 : 0,","        totalPresencas,","        totalAulas,","      }","    })","","    // Aulas por instrutor (via turmas)","    const turmasEdu = await prisma.turmas_oxetech_edu.findMany({","      select: {","        id: true,","        titulo: true,","        escola_id: true,","        escolas_oxetech_edu: {","          select: {","            nome: true,","          },","        },","      },","    })","","    // Matrículas por curso (via turmas)","    const matriculasPorCursoPromises = turmasEdu.map(async (turma) => {","      const totalMatriculas = await prisma.inscricoes_turmas_oxetech_edu.count({","        where: {","          turma_id: turma.id,","        },","      })","","      return {","        curso: turma.titulo,","        escola: turma.escolas_oxetech_edu?.nome || 'Sem escola',","        totalMatriculas,","      }","    })","","    const matriculasPorCurso = await Promise.all(matriculasPorCursoPromises)","","    // Estatísticas gerais","    const [totalEscolas, totalMatriculas, totalTurmas] = await Promise.all([","      prisma.escolas_oxetech_edu.count(),","      prisma.matriculas_oxetech_edu.count(),","      prisma.turmas_oxetech_edu.count(),","    ])","","    // Matrículas com status","    const matriculasComStatus = await prisma.matriculas_oxetech_edu.groupBy({","      by: ['status'],","      _count: true,","    })","","    return NextResponse.json({","      frequenciaPorEscola,","      matriculasPorCurso,","      stats: {","        totalEscolas,","        totalMatriculas,","        totalTurmas,","      },","      matriculasPorStatus: matriculasComStatus.map((item) => ({","        status: item.status,","        total: item._count,","      })),","    })","  } catch (error) {","    console.error('Error fetching edu data:', error)","    return NextResponse.json(","      { error: 'Failed to fetch edu data' },","      { status: 500 }","    )","  }","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000002,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000002,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000026,1000033,1000030,1000031,1000002,1000034,1000035,1000036,1000037,1000038,1000039,1000040,1000023,1000002,1000041,1000042,1000008,1000009,1000043,1000044,1000045,1000012,1000046,1000020,1000021,1000022,1000023,1000002,1000047,1000048,1000049,1000050,1000051,1000021,1000052,1000002,1000034,1000053,1000054,1000055,1000040,1000023,1000002,1000056,1000002,1000057,1000058,1000059,1000060,1000061,1000062,1000002,1000063,1000064,1000065,1000066,1000023,1000002,1000067,1000068,1000069,1000070,1000071,1000055,1000072,1000022,1000073,1000074,1000075,1000076,1000023,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000002,1000002]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
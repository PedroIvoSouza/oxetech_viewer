{"fsPath":"\\home\\oxetech_mcz\\app\\api\\lab\\route.ts","fileUuid":"daac9301-c5a6-48b1-87ca-a4e2f00fecf6","fileSizeBytes":3191,"numLines":125,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":126,"addedLines":["import { NextResponse } from 'next/server'","import { prisma } from '@/lib/db'","","export const dynamic = 'force-dynamic'","","export async function GET() {","  try {","    // Inscrições Lab","    const inscricoes = await prisma.oxetechlab_inscricoes.findMany({","      select: {","        id: true,","        status: true,","        created_at: true,","        aluno_id: true,","        turma_id: true,","        turmas: {","          select: {","            id: true,","            titulo: true,","            laboratorios: {","              select: {","                nome: true,","              },","            },","          },","        },","      },","      orderBy: {","        created_at: 'desc',","      },","    })","","    // Distribuição por curso (via turma)","    const distribuicaoPorCurso = inscricoes.reduce((acc, inscricao) => {","      const curso = inscricao.turmas?.titulo || 'Sem curso'","      acc[curso] = (acc[curso] || 0) + 1","      return acc","    }, {} as Record<string, number>)","","    const distribuicaoPorCursoArray = Object.entries(distribuicaoPorCurso).map(","      ([curso, total]) => ({","        curso,","        total,","      })","    )","","    // Evolução temporal","    const evolucaoTemporal = inscricoes.reduce((acc, inscricao) => {","      const month = new Date(inscricao.created_at).toLocaleDateString('pt-BR', {","        month: 'short',","        year: 'numeric',","      })","      acc[month] = (acc[month] || 0) + 1","      return acc","    }, {} as Record<string, number>)","","    const evolucaoTemporalArray = Object.entries(evolucaoTemporal).map(","      ([mes, total]) => ({","        mes,","        inscricoes: total,","      })","    )","","    // Estatísticas gerais","    const [totalInscricoes, totalInscricoesPorStatus] = await Promise.all([","      prisma.oxetechlab_inscricoes.count(),","      prisma.oxetechlab_inscricoes.groupBy({","        by: ['status'],","        _count: true,","      }),","    ])","","    // Inscrições por laboratório","    const turmas = await prisma.turmas.findMany({","      select: {","        id: true,","        titulo: true,","        laboratorios: {","          select: {","            nome: true,","          },","        },","        oxetechlab_inscricoes: {","          select: {","            id: true,","          },","        },","      },","    })","","    const inscricoesPorLaboratorio = turmas.reduce((acc, turma) => {","      const lab = turma.laboratorios?.nome || 'Sem laboratório'","      acc[lab] = (acc[lab] || 0) + turma.oxetechlab_inscricoes.length","      return acc","    }, {} as Record<string, number>)","","    const inscricoesPorLaboratorioArray = Object.entries(","      inscricoesPorLaboratorio","    ).map(([laboratorio, total]) => ({","      laboratorio,","      total,","    }))","","    return NextResponse.json({","      stats: {","        totalInscricoes,","        inscricoesPorStatus: totalInscricoesPorStatus.map((item) => ({","          status: item.status,","          total: item._count,","        })),","      },","      distribuicaoPorCurso: distribuicaoPorCursoArray,","      evolucaoTemporal: evolucaoTemporalArray,","      inscricoesPorLaboratorio: inscricoesPorLaboratorioArray,","    })","  } catch (error) {","    console.error('Error fetching lab data:', error)","    return NextResponse.json(","      { error: 'Failed to fetch lab data' },","      { status: 500 }","    )","  }","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000002,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000025,1000028,1000002,1000029,1000030,1000031,1000032,1000033,1000034,1000002,1000035,1000036,1000037,1000038,1000039,1000040,1000002,1000041,1000042,1000043,1000044,1000045,1000039,1000046,1000033,1000034,1000002,1000047,1000048,1000049,1000050,1000039,1000040,1000002,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000002,1000059,1000060,1000008,1000009,1000061,1000062,1000015,1000063,1000023,1000024,1000064,1000015,1000016,1000023,1000024,1000025,1000028,1000002,1000065,1000066,1000067,1000033,1000034,1000002,1000068,1000069,1000070,1000071,1000072,1000073,1000002,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000025,1000081,1000082,1000083,1000028,1000084,1000085,1000086,1000087,1000088,1000040,1000089,1000090,1000002,1000002]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
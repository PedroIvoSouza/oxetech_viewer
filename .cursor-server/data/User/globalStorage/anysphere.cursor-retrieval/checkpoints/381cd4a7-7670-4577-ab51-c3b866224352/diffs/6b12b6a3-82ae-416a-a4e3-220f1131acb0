{"fsPath":"\\home\\oxetech_mcz\\app\\api\\home\\route.ts","fileUuid":"6b12b6a3-82ae-416a-a4e3-220f1131acb0","fileSizeBytes":3877,"numLines":153,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":154,"addedLines":["import { NextResponse } from 'next/server'","import { prisma } from '@/lib/db'","","export const dynamic = 'force-dynamic'","","export async function GET() {","  try {","    // KPIs Gerais","    const [","      totalAlunos,","      totalEmpresas,","      totalMatriculasEdu,","      totalInscricoesWork,","      totalVagasWork,","      totalCandidaturasWork,","      totalContratacoesWork,","      totalTrilhas,","      totalAtividadesConcluidas,","      totalFrequencias,","      totalInstrutores,","      totalAgentes,","    ] = await Promise.all([","      prisma.alunos.count(),","      prisma.empresas.count(),","      prisma.matriculas_oxetech_edu.count(),","      prisma.oxetechwork_inscricao_alunos.count(),","      prisma.vagas.count(),","      prisma.candidaturas.count(),","      prisma.contratacoes.count(),","      prisma.trilhas_de_conhecimento.count(),","      prisma.modulos_trilhas_alunos.count({","        where: { curso_concluido: true },","      }),","      prisma.frequencias.count(),","      prisma.instrutores.count(),","      prisma.agentes.count(),","    ])","","    // Evolução mensal de alunos","    const alunos = await prisma.alunos.findMany({","      select: {","        created_at: true,","      },","      orderBy: {","        created_at: 'asc',","      },","    })","","    const evolucaoAlunos = alunos.reduce((acc, aluno) => {","      const month = new Date(aluno.created_at).toLocaleDateString('pt-BR', {","        month: 'short',","        year: 'numeric',","      })","      acc[month] = (acc[month] || 0) + 1","      return acc","    }, {} as Record<string, number>)","","    const evolucaoAlunosArray = Object.entries(evolucaoAlunos).map(","      ([mes, total]) => ({","        mes,","        total,","      })","    )","","    // Evolução Work","    const inscricoesWork = await prisma.oxetechwork_inscricao_alunos.findMany({","      select: {","        created_at: true,","      },","      orderBy: {","        created_at: 'asc',","      },","    })","","    const evolucaoWork = inscricoesWork.reduce((acc, inscricao) => {","      const month = new Date(inscricao.created_at).toLocaleDateString('pt-BR', {","        month: 'short',","        year: 'numeric',","      })","      acc[month] = (acc[month] || 0) + 1","      return acc","    }, {} as Record<string, number>)","","    const evolucaoWorkArray = Object.entries(evolucaoWork).map(([mes, total]) => ({","      mes,","      inscricoes: total,","    }))","","    // Funil Work","    const funilWork = {","      inscricoes: totalInscricoesWork,","      candidaturas: totalCandidaturasWork,","      contratacoes: totalContratacoesWork,","    }","","    // Conclusão de trilhas","    const trilhasConcluidas = await prisma.inscricoes_trilhas_alunos.findMany({","      where: {","        concluido: true,","      },","      select: {","        trilha_id: true,","        trilhas_de_conhecimento: {","          select: {","            titulo: true,","          },","        },","      },","    })","","    const conclusaoTrilhas = trilhasConcluidas.reduce((acc, item) => {","      const titulo = item.trilhas_de_conhecimento?.titulo || 'Sem título'","      acc[titulo] = (acc[titulo] || 0) + 1","      return acc","    }, {} as Record<string, number>)","","    const conclusaoTrilhasArray = Object.entries(conclusaoTrilhas).map(","      ([trilha, total]) => ({","        trilha,","        total,","      })","    )","","    return NextResponse.json({","      kpis: {","        totalAlunos,","        totalEmpresas,","        totalMatriculasEdu,","        totalInscricoesWork,","        totalVagasWork,","        totalCandidaturasWork,","        totalContratacoesWork,","        totalTrilhas,","        totalAtividadesConcluidas,","        totalFrequencias,","        totalInstrutores,","        totalAgentes,","      },","      evolucaoAlunos: evolucaoAlunosArray,","      evolucaoWork: evolucaoWorkArray,","      funilWork,","      conclusaoTrilhas: conclusaoTrilhasArray,","    })","  } catch (error) {","    console.error('Error fetching home data:', error)","    return NextResponse.json(","      { error: 'Failed to fetch home data' },","      { status: 500 }","    )","  }","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000002,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000002,1000036,1000037,1000038,1000039,1000040,1000041,1000042,1000040,1000043,1000002,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000002,1000052,1000053,1000054,1000055,1000048,1000056,1000002,1000057,1000058,1000038,1000039,1000040,1000041,1000042,1000040,1000043,1000002,1000059,1000060,1000046,1000047,1000048,1000049,1000050,1000051,1000002,1000061,1000062,1000063,1000064,1000002,1000065,1000066,1000067,1000068,1000069,1000070,1000002,1000071,1000072,1000073,1000074,1000040,1000038,1000075,1000076,1000077,1000078,1000079,1000080,1000040,1000043,1000002,1000081,1000082,1000083,1000050,1000051,1000002,1000084,1000085,1000086,1000055,1000048,1000056,1000002,1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000040,1000101,1000102,1000103,1000104,1000043,1000105,1000106,1000107,1000108,1000109,1000056,1000110,1000111,1000002,1000002]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
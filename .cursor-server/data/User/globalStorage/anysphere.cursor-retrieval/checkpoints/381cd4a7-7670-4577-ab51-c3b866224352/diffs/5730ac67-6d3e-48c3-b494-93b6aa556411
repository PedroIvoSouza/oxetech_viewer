{"fsPath":"\\home\\oxetech_mcz\\app\\api\\work\\route.ts","fileUuid":"5730ac67-6d3e-48c3-b494-93b6aa556411","fileSizeBytes":3363,"numLines":136,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":137,"addedLines":["import { NextResponse } from 'next/server'","import { prisma } from '@/lib/db'","","export const dynamic = 'force-dynamic'","","export async function GET() {","  try {","    // EstatÃ­sticas gerais","    const [vagas, empresas, candidaturas, contratacoes] = await Promise.all([","      prisma.vagas.count(),","      prisma.empresas.count({","        where: { oxetech_work: true },","      }),","      prisma.candidaturas.count(),","      prisma.contratacoes.count(),","    ])","","    // Funil por edital","    const editais = await prisma.oxetechwork_editals.findMany({","      select: {","        id: true,","        title: true,","        qt_vagas: true,","        qt_vagas_em_oferta: true,","        qt_vagas_preenchidas: true,","        oxetechwork_inscricao_alunos: {","          select: {","            id: true,","          },","        },","      },","    })","","    const funilPorEditalPromises = editais.map(async (edital) => {","      const [candidaturasCount, contratacoesCount] = await Promise.all([","        prisma.candidaturas.count({","          where: {","            vagas: {","              ciclo_id: {","                in: (await prisma.oxetechwork_ciclos.findMany({","                  where: { edital_id: edital.id },","                  select: { id: true },","                })).map((c) => c.id),","              },","            },","          },","        }),","        prisma.contratacoes.count({","          where: {","            oxetechwork_ciclos: {","              edital_id: edital.id,","            },","          },","        }),","      ])","","      return {","        edital: edital.title,","        inscricoes: edital.oxetechwork_inscricao_alunos.length,","        candidaturas: candidaturasCount,","        contratacoes: contratacoesCount,","      }","    })","","    const funilPorEdital = await Promise.all(funilPorEditalPromises)","","    // Empresas com KPIs","    const empresasComKPIs = await prisma.empresas.findMany({","      where: { oxetech_work: true },","      select: {","        id: true,","        razao_social: true,","        email: true,","        vagas: {","          select: {","            id: true,","            titulo: true,","            status: true,","            candidaturas: {","              select: {","                id: true,","              },","            },","          },","        },","        oxetechwork_inscricao_empresas: {","          select: {","            id: true,","          },","        },","      },","      take: 50,","    })","","    const empresasData = empresasComKPIs.map((empresa) => ({","      id: empresa.id,","      razao_social: empresa.razao_social,","      email: empresa.email,","      totalVagas: empresa.vagas.length,","      totalCandidaturas: empresa.vagas.reduce(","        (acc, vaga) => acc + vaga.candidaturas.length,","        0","      ),","      totalInscricoes: empresa.oxetechwork_inscricao_empresas.length,","    }))","","    // Vagas por status","    const vagasPorStatus = await prisma.vagas.groupBy({","      by: ['status'],","      _count: true,","    })","","    return NextResponse.json({","      stats: {","        vagas,","        empresas,","        candidaturas,","        contratacoes,","      },","      funilPorEdital,","      empresas: empresasData,","      vagasPorStatus: vagasPorStatus.map((item) => ({","        status: item.status,","        total: item._count,","      })),","    })","  } catch (error) {","    console.error('Error fetching work data:', error)","    return NextResponse.json(","      { error: 'Failed to fetch work data' },","      { status: 500 }","    )","  }","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000002,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000002,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000002,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000040,1000041,1000026,1000042,1000043,1000033,1000044,1000045,1000041,1000026,1000042,1000046,1000002,1000047,1000048,1000049,1000050,1000051,1000052,1000029,1000002,1000053,1000002,1000054,1000055,1000056,1000017,1000018,1000057,1000058,1000059,1000024,1000025,1000060,1000061,1000062,1000063,1000064,1000040,1000041,1000026,1000027,1000065,1000024,1000025,1000026,1000027,1000028,1000066,1000029,1000002,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000002,1000078,1000079,1000080,1000081,1000029,1000002,1000082,1000083,1000084,1000085,1000086,1000087,1000028,1000088,1000089,1000090,1000091,1000092,1000093,1000029,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000002,1000002]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
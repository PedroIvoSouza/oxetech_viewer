{"fsPath":"\\home\\oxetech_mcz\\app\\api\\trilhas\\route.ts","fileUuid":"501cc534-c7fd-4f65-97c4-96ea516d2e29","fileSizeBytes":4493,"numLines":167,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":168,"addedLines":["import { NextResponse } from 'next/server'","import { prisma } from '@/lib/db'","","export const dynamic = 'force-dynamic'","","export async function GET() {","  try {","    // Listar trilhas com módulos e atividades","    const trilhas = await prisma.trilhas_de_conhecimento.findMany({","      select: {","        id: true,","        titulo: true,","        descricao: true,","        carga_horaria: true,","        created_at: true,","        modulos_trilhas: {","          select: {","            id: true,","            curso_id: true,","            cursos: {","              select: {","                id: true,","                titulo: true,","                descricao: true,","              },","            },","            modulos_trilhas_pdfs: {","              select: {","                id: true,","                nome: true,","              },","            },","          },","        },","      },","      orderBy: {","        created_at: 'desc',","      },","    })","","    // Progresso médio dos alunos por trilha","    const inscricoes = await prisma.inscricoes_trilhas_alunos.findMany({","      select: {","        trilha_id: true,","        concluido: true,","        trilhas_de_conhecimento: {","          select: {","            titulo: true,","          },","        },","        modulos_trilhas_alunos: {","          select: {","            curso_concluido: true,","            atividade_concluida: true,","          },","        },","      },","    })","","    const progressoPorTrilha = trilhas.map((trilha) => {","      const inscricoesTrilha = inscricoes.filter(","        (insc) => insc.trilha_id === trilha.id","      )","      const totalInscritos = inscricoesTrilha.length","      const concluidos = inscricoesTrilha.filter((i) => i.concluido).length","","      // Calcular progresso médio dos módulos","      const progressoMedio =","        totalInscritos > 0","          ? inscricoesTrilha.reduce((acc, insc) => {","              const modulosConcluidos = insc.modulos_trilhas_alunos.filter(","                (m) => m.curso_concluido && m.atividade_concluida","              ).length","              const totalModulos = trilha.modulos_trilhas.length","              return (","                acc + (totalModulos > 0 ? modulosConcluidos / totalModulos : 0)","              )","            }, 0) / totalInscritos","          : 0","","      return {","        trilha: trilha.titulo,","        totalInscritos,","        concluidos,","        progressoMedio: progressoMedio * 100,","      }","    })","","    // Tabela de inscritos com % concluído","    const inscritosDetalhados = await prisma.inscricoes_trilhas_alunos.findMany(","      {","        select: {","          id: true,","          aluno_id: true,","          concluido: true,","          alunos: {","            select: {","              id: true,","              name: true,","              email: true,","            },","          },","          trilhas_de_conhecimento: {","            select: {","              titulo: true,","            },","          },","          modulos_trilhas_alunos: {","            select: {","              curso_concluido: true,","              atividade_concluida: true,","            },","          },","        },","        take: 100,","      }","    )","","    const trilhasComModulos = await prisma.trilhas_de_conhecimento.findMany({","      select: {","        id: true,","        modulos_trilhas: {","          select: {","            id: true,","          },","        },","      },","    })","","    const inscritosComProgresso = inscritosDetalhados.map((inscricao) => {","      const modulosConcluidos = inscricao.modulos_trilhas_alunos.filter(","        (m) => m.curso_concluido && m.atividade_concluida","      ).length","      ","      // Buscar total de módulos da trilha","      const trilhaModulos = trilhasComModulos.find(","        (t) => t.id === inscricao.trilha_id","      )","      const totalModulos = trilhaModulos?.modulos_trilhas.length || inscricao.modulos_trilhas_alunos.length","      const percentualConcluido =","        totalModulos > 0 ? (modulosConcluidos / totalModulos) * 100 : 0","","      return {","        id: inscricao.id,","        aluno: inscricao.alunos?.name || 'Sem nome',","        email: inscricao.alunos?.email || 'Sem email',","        trilha: inscricao.trilhas_de_conhecimento?.titulo || 'Sem trilha',","        concluido: inscricao.concluido,","        percentualConcluido,","      }","    })","","    return NextResponse.json({","      trilhas,","      progressoPorTrilha,","      inscritos: inscritosComProgresso,","    })","  } catch (error) {","    console.error('Error fetching trilhas data:', error)","    return NextResponse.json(","      { error: 'Failed to fetch trilhas data' },","      { status: 500 }","    )","  }","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000002,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000019,1000020,1000026,1000023,1000024,1000027,1000028,1000029,1000030,1000031,1000029,1000032,1000002,1000033,1000034,1000008,1000035,1000036,1000037,1000015,1000038,1000027,1000028,1000039,1000015,1000040,1000041,1000027,1000028,1000029,1000032,1000002,1000042,1000043,1000044,1000045,1000046,1000047,1000002,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000002,1000061,1000062,1000063,1000064,1000065,1000066,1000032,1000002,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000024,1000027,1000079,1000075,1000080,1000024,1000027,1000081,1000075,1000082,1000083,1000024,1000027,1000028,1000084,1000066,1000085,1000002,1000086,1000008,1000009,1000014,1000015,1000016,1000027,1000028,1000029,1000032,1000002,1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000094,1000045,1000095,1000096,1000097,1000002,1000061,1000098,1000099,1000100,1000101,1000102,1000103,1000066,1000032,1000002,1000104,1000105,1000106,1000107,1000032,1000108,1000109,1000110,1000111,1000112,1000085,1000113,1000114,1000002,1000002]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
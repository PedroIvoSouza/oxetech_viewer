{"fsPath":"\\home\\oxetech_mcz\\app\\api\\edu\\route.ts","fileUuid":"255a6e9d-b01d-4c58-b0a3-58ccd17cf653","fileSizeBytes":6853,"numLines":247,"diffChanges":[{"originalStartLineNumberOneIndexed":13,"originalEndLineNumberExclusiveOneIndexed":13,"modifiedStartLineNumberOneIndexed":13,"modifiedEndLineNumberExclusiveOneIndexed":14,"addedLines":["        municipio: true,"],"tokenizedAddedLines":[1000085]},{"originalStartLineNumberOneIndexed":20,"originalEndLineNumberExclusiveOneIndexed":20,"modifiedStartLineNumberOneIndexed":21,"modifiedEndLineNumberExclusiveOneIndexed":29,"addedLines":["                created_at: true,","                turmas_oxetech_edu: {","                  select: {","                    dia_da_aula: true,","                    hora_inicio: true,","                    hora_fim: true,","                  },","                },"],"tokenizedAddedLines":[1000086,1000087,1000088,1000089,1000090,1000091,1000092,1000093]},{"originalStartLineNumberOneIndexed":43,"originalEndLineNumberExclusiveOneIndexed":43,"modifiedStartLineNumberOneIndexed":52,"modifiedEndLineNumberExclusiveOneIndexed":53,"addedLines":["        municipio: escola.municipio,"],"tokenizedAddedLines":[1000094]},{"originalStartLineNumberOneIndexed":47,"originalEndLineNumberExclusiveOneIndexed":51,"modifiedStartLineNumberOneIndexed":57,"modifiedEndLineNumberExclusiveOneIndexed":109,"addedLines":["        totalMatriculas: escola.matriculas_oxetech_edu.length,","      }","    })","","    // Frequência diária (últimos 30 dias)","    const trintaDiasAtras = new Date()","    trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30)","","    const inscricoesRecentes = await prisma.inscricoes_turmas_oxetech_edu.findMany(","      {","        where: {","          created_at: {","            gte: trintaDiasAtras,","          },","        },","        select: {","          presente: true,","          created_at: true,","        },","      }","    )","","    const frequenciaDiaria = []","    for (let i = 29; i >= 0; i--) {","      const data = new Date()","      data.setDate(data.getDate() - i)","      const dataStr = data.toLocaleDateString('pt-BR', {","        day: '2-digit',","        month: '2-digit',","      })","","      const inscricoesDia = inscricoesRecentes.filter((insc) => {","        const inscData = new Date(insc.created_at)","        return (","          inscData.getDate() === data.getDate() &&","          inscData.getMonth() === data.getMonth() &&","          inscData.getFullYear() === data.getFullYear()","        )","      })","","      const presencas = inscricoesDia.filter((i) => i.presente).length","      const total = inscricoesDia.length","","      frequenciaDiaria.push({","        dia: dataStr,","        frequencia: total > 0 ? (presencas / total) * 100 : 0,","        presencas,","        total,","      })","    }","","    // Ranking de cursos mais procurados"],"tokenizedAddedLines":[1000095,41,24,3,1000096,1000097,1000098,3,1000099,1000100,51,1000101,1000102,21,22,1000103,1000104,1000105,22,41,83,3,1000106,1000107,1000108,1000109,1000110,1000111,1000112,53,3,1000113,1000114,1000115,1000116,1000117,1000118,1000119,53,3,1000120,1000121,3,1000122,1000123,1000124,1000125,1000126,53,1000127,3,1000128]},{"originalStartLineNumberOneIndexed":61,"originalEndLineNumberExclusiveOneIndexed":67,"modifiedStartLineNumberOneIndexed":119,"modifiedEndLineNumberExclusiveOneIndexed":174,"addedLines":["        inscricoes_turmas_oxetech_edu: {","          select: {","            id: true,","          },","        },","      },","    })","","    const cursosData = turmasEdu.map((turma) => ({","      curso: turma.titulo,","      escola: turma.escolas_oxetech_edu?.nome || 'Sem escola',","      totalMatriculas: turma.inscricoes_turmas_oxetech_edu.length,","    }))","","    const rankingCursos = cursosData","      .sort((a, b) => b.totalMatriculas - a.totalMatriculas)","      .slice(0, 10)","","    // Matrículas por curso (completo)","    const matriculasPorCurso = cursosData.sort(","      (a, b) => b.totalMatriculas - a.totalMatriculas","    )","","    // Mapa de calor por horário","    const horariosMap = new Map<string, number>()","","    escolas.forEach((escola) => {","      escola.matriculas_oxetech_edu.forEach((matricula) => {","        matricula.inscricoes_turmas_oxetech_edu.forEach((inscricao) => {","          if (inscricao.presente && inscricao.turmas_oxetech_edu) {","            const hora = inscricao.turmas_oxetech_edu.hora_inicio","            const diaSemana = new Date(","              inscricao.turmas_oxetech_edu.dia_da_aula","            ).toLocaleDateString('pt-BR', { weekday: 'short' })","","            const key = `${diaSemana} - ${hora}`","            horariosMap.set(key, (horariosMap.get(key) || 0) + 1)","          }","        })","      })","    })","","    const mapaCalorHorario = Array.from(horariosMap.entries())","      .map(([horario, frequencia]) => ({","        horario,","        frequencia,","      }))","      .sort((a, b) => b.frequencia - a.frequencia)","      .slice(0, 20)","","    // Comparativo mensal de matrículas (últimos 12 meses)","    const dozeMesesAtras = new Date()","    dozeMesesAtras.setMonth(dozeMesesAtras.getMonth() - 12)","","    const matriculasRecentes = await prisma.matriculas_oxetech_edu.findMany({"],"tokenizedAddedLines":[1000129,13,14,21,22,23,24,3,1000130,1000131,1000132,1000133,1000134,3,1000135,1000136,1000137,3,1000138,1000139,1000140,83,3,1000141,1000142,3,1000143,1000144,1000145,1000146,1000147,1000148,1000149,1000150,3,1000151,1000152,1000153,1000154,53,24,3,1000155,1000156,1000157,1000158,1000159,1000160,1000161,3,1000162,1000163,1000164,3,1000165]},{"originalStartLineNumberOneIndexed":68,"originalEndLineNumberExclusiveOneIndexed":80,"modifiedStartLineNumberOneIndexed":175,"modifiedEndLineNumberExclusiveOneIndexed":205,"addedLines":["        created_at: {","          gte: dozeMesesAtras,","        },","      },","      select: {","        created_at: true,","      },","    })","","    const comparativoMensal = []","    for (let i = 11; i >= 0; i--) {","      const mes = new Date()","      mes.setMonth(mes.getMonth() - i)","","      const inicioMes = new Date(mes.getFullYear(), mes.getMonth(), 1)","      const fimMes = new Date(mes.getFullYear(), mes.getMonth() + 1, 0)","","      const matriculasMes = matriculasRecentes.filter((matricula) => {","        const dataMatricula = new Date(matricula.created_at)","        return dataMatricula >= inicioMes && dataMatricula <= fimMes","      }).length","","      comparativoMensal.push({","        mes: mes.toLocaleDateString('pt-BR', {","          month: 'short',","          year: 'numeric',","        }),","        matriculas: matriculasMes,","      })","    }"],"tokenizedAddedLines":[1000166,1000167,22,23,9,1000168,23,24,3,1000169,1000170,1000171,1000172,3,1000173,1000174,3,1000175,1000176,1000177,1000178,3,1000179,1000180,1000181,1000182,1000183,1000184,53,1000127]},{"originalStartLineNumberOneIndexed":95,"originalEndLineNumberExclusiveOneIndexed":95,"modifiedStartLineNumberOneIndexed":220,"modifiedEndLineNumberExclusiveOneIndexed":221,"addedLines":["      data: {"],"tokenizedAddedLines":[1000185]},{"originalStartLineNumberOneIndexed":96,"originalEndLineNumberExclusiveOneIndexed":96,"modifiedStartLineNumberOneIndexed":222,"modifiedEndLineNumberExclusiveOneIndexed":224,"addedLines":["        frequenciaDiaria,","        rankingCursos,"],"tokenizedAddedLines":[1000186,1000187]},{"originalStartLineNumberOneIndexed":97,"originalEndLineNumberExclusiveOneIndexed":97,"modifiedStartLineNumberOneIndexed":225,"modifiedEndLineNumberExclusiveOneIndexed":227,"addedLines":["        mapaCalorHorario,","        comparativoMensal,"],"tokenizedAddedLines":[1000188,1000189]},{"originalStartLineNumberOneIndexed":106,"originalEndLineNumberExclusiveOneIndexed":106,"modifiedStartLineNumberOneIndexed":236,"modifiedEndLineNumberExclusiveOneIndexed":238,"addedLines":["      },","      error: null,"],"tokenizedAddedLines":[23,1000190]},{"originalStartLineNumberOneIndexed":110,"originalEndLineNumberExclusiveOneIndexed":111,"modifiedStartLineNumberOneIndexed":242,"modifiedEndLineNumberExclusiveOneIndexed":243,"addedLines":["      { data: null, error: 'Failed to fetch edu data' },"],"tokenizedAddedLines":[1000191]},{"originalStartLineNumberOneIndexed":115,"originalEndLineNumberExclusiveOneIndexed":116,"modifiedStartLineNumberOneIndexed":247,"modifiedEndLineNumberExclusiveOneIndexed":247}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}
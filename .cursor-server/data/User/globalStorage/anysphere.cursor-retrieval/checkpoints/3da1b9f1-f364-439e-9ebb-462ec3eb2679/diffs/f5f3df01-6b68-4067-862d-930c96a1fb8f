{"fsPath":"\\home\\oxetech_mcz\\app\\api\\work\\route.ts","fileUuid":"f5f3df01-6b68-4067-862d-930c96a1fb8f","fileSizeBytes":8922,"numLines":325,"diffChanges":[{"originalStartLineNumberOneIndexed":26,"originalEndLineNumberExclusiveOneIndexed":26,"modifiedStartLineNumberOneIndexed":26,"modifiedEndLineNumberExclusiveOneIndexed":28,"addedLines":["        dt_inicio_edital: true,","        dt_encerramento_edital: true,"],"tokenizedAddedLines":[1000102,1000103]},{"originalStartLineNumberOneIndexed":29,"originalEndLineNumberExclusiveOneIndexed":29,"modifiedStartLineNumberOneIndexed":31,"modifiedEndLineNumberExclusiveOneIndexed":32,"addedLines":["            created_at: true,"],"tokenizedAddedLines":[1000104]},{"originalStartLineNumberOneIndexed":32,"originalEndLineNumberExclusiveOneIndexed":32,"modifiedStartLineNumberOneIndexed":35,"modifiedEndLineNumberExclusiveOneIndexed":38,"addedLines":["      orderBy: {","        dt_inicio_edital: 'desc',","      },"],"tokenizedAddedLines":[1000105,1000106,29]},{"originalStartLineNumberOneIndexed":35,"originalEndLineNumberExclusiveOneIndexed":35,"modifiedStartLineNumberOneIndexed":41,"modifiedEndLineNumberExclusiveOneIndexed":48,"addedLines":["      const ciclos = await prisma.oxetechwork_ciclos.findMany({","        where: { edital_id: edital.id },","        select: { id: true },","      })","","      const cicloIds = ciclos.map((c) => c.id)",""],"tokenizedAddedLines":[1000107,1000108,1000109,1000110,3,1000111,3]},{"originalStartLineNumberOneIndexed":40,"originalEndLineNumberExclusiveOneIndexed":44,"modifiedStartLineNumberOneIndexed":53,"modifiedEndLineNumberExclusiveOneIndexed":54,"addedLines":["                in: cicloIds.length > 0 ? cicloIds : [-1],"],"tokenizedAddedLines":[1000112]},{"originalStartLineNumberOneIndexed":62,"originalEndLineNumberExclusiveOneIndexed":62,"modifiedStartLineNumberOneIndexed":72,"modifiedEndLineNumberExclusiveOneIndexed":75,"addedLines":["        totalVagas: edital.qt_vagas,","        vagasOferta: edital.qt_vagas_em_oferta,","        vagasPreenchidas: edital.qt_vagas_preenchidas,"],"tokenizedAddedLines":[1000113,1000114,1000115]},{"originalStartLineNumberOneIndexed":67,"originalEndLineNumberExclusiveOneIndexed":68,"modifiedStartLineNumberOneIndexed":80,"modifiedEndLineNumberExclusiveOneIndexed":81,"addedLines":["    // Empresas com KPIs (ranking)"],"tokenizedAddedLines":[1000116]},{"originalStartLineNumberOneIndexed":92,"originalEndLineNumberExclusiveOneIndexed":96,"modifiedStartLineNumberOneIndexed":105,"modifiedEndLineNumberExclusiveOneIndexed":121,"addedLines":["      take: 100,","    })","","    const empresasData = empresasComKPIs","      .map((empresa) => {","        const totalContratacoes = empresa.vagas.reduce((acc, vaga) => {","          return (","            acc +","            vaga.candidaturas.filter((c) => {","              // Contratacoes relacionadas","              return true // Será calculado melhor depois","            }).length","          )","        }, 0)","","        return {"],"tokenizedAddedLines":[1000117,30,3,1000118,1000119,1000120,1000121,1000122,1000123,1000124,1000125,1000126,1000127,1000128,3,1000129]},{"originalStartLineNumberOneIndexed":105,"originalEndLineNumberExclusiveOneIndexed":106,"modifiedStartLineNumberOneIndexed":130,"modifiedEndLineNumberExclusiveOneIndexed":147,"addedLines":["          totalContratacoes,","          taxaConversao:","            empresa.vagas.reduce((acc, vaga) => acc + vaga.candidaturas.length, 0) >","            0","              ? (","                  (totalContratacoes /","                    empresa.vagas.reduce(","                      (acc, vaga) => acc + vaga.candidaturas.length,","                      0","                    )) *","                  100","                ).toFixed(1)","              : '0.0',","        }","      })","      .sort((a, b) => b.totalContratacoes - a.totalContratacoes)","      .slice(0, 50)"],"tokenizedAddedLines":[1000130,1000131,1000132,1000133,1000134,1000135,1000136,1000137,1000138,1000139,1000140,1000141,1000142,1000143,1000110,1000144,1000145]},{"originalStartLineNumberOneIndexed":113,"originalEndLineNumberExclusiveOneIndexed":113,"modifiedStartLineNumberOneIndexed":154,"modifiedEndLineNumberExclusiveOneIndexed":286,"addedLines":["    const vagasDetalhadas = await prisma.vagas.findMany({","      select: {","        id: true,","        titulo: true,","        status: true,","        quantidade: true,","        data_encerramento: true,","        created_at: true,","        empresas: {","          select: {","            razao_social: true,","          },","        },","        candidaturas: {","          select: {","            id: true,","          },","        },","      },","      where: {","        oxetech_work: true,","      },","      orderBy: {","        created_at: 'desc',","      },","      take: 50,","    })","","    // Tempo médio entre etapas","    const contratacoesComTempo = await prisma.contratacoes.findMany({","      select: {","        created_at: true,","        candidaturas: {","          select: {","            created_at: true,","            aluno_id: true,","            vaga_id: true,","            vagas: {","              select: {","                ciclo_id: true,","                oxetechwork_ciclos: {","                  select: {","                    edital_id: true,","                    oxetechwork_editals: {","                      select: {","                        dt_inicio_inscricao_aluno: true,","                      },","                    },","                  },","                },","              },","            },","          },","        },","      },","      take: 100,","    })","","    // Buscar inscrições dos alunos para calcular tempo","    const alunosIds = contratacoesComTempo","      .map((c) => c.candidaturas?.aluno_id)","      .filter((id): id is number => id !== undefined)","","    const inscricoesAlunos = await prisma.oxetechwork_inscricao_alunos.findMany({","      where: {","        aluno_id: {","          in: alunosIds,","        },","      },","      select: {","        aluno_id: true,","        created_at: true,","        edital_id: true,","      },","    })","","    const temposMedios = contratacoesComTempo","      .map((contratacao) => {","        if (!contratacao.candidaturas) return null","","        const alunoId = contratacao.candidaturas.aluno_id","        const editalId =","          contratacao.candidaturas.vagas?.oxetechwork_ciclos?.edital_id","","        const inscricaoAluno = inscricoesAlunos.find(","          (i) => i.aluno_id === alunoId && i.edital_id === editalId","        )","","        const dataInscricao = inscricaoAluno?.created_at","        const dataCandidatura = contratacao.candidaturas.created_at","        const dataContratacao = contratacao.created_at","","        if (dataInscricao && dataCandidatura && dataContratacao) {","          const tempoInscricaoCandidatura =","            (new Date(dataCandidatura).getTime() -","              new Date(dataInscricao).getTime()) /","            (1000 * 60 * 60 * 24) // dias","","          const tempoCandidaturaContratacao =","            (new Date(dataContratacao).getTime() -","              new Date(dataCandidatura).getTime()) /","            (1000 * 60 * 60 * 24) // dias","","          return {","            inscricaoCandidatura: tempoInscricaoCandidatura,","            candidaturaContratacao: tempoCandidaturaContratacao,","          }","        }","","        return null","      })","      .filter((t) => t !== null) as Array<{","      inscricaoCandidatura: number","      candidaturaContratacao: number","    }>","","    const tempoMedioInscricaoCandidatura =","      temposMedios.length > 0","        ? temposMedios.reduce(","            (acc, t) => acc + t.inscricaoCandidatura,","            0","          ) / temposMedios.length","        : 0","","    const tempoMedioCandidaturaContratacao =","      temposMedios.length > 0","        ? temposMedios.reduce(","            (acc, t) => acc + t.candidaturaContratacao,","            0","          ) / temposMedios.length","        : 0",""],"tokenizedAddedLines":[1000146,18,19,1000147,1000148,1000149,1000150,1000151,1000152,25,1000153,27,28,1000154,25,26,27,28,29,1000155,1000156,29,1000105,1000157,29,67,30,3,1000158,1000159,18,1000151,1000154,25,1000104,1000160,1000161,35,64,1000162,1000163,1000164,1000165,1000166,1000167,1000168,1000169,1000170,1000171,1000172,41,42,27,28,29,1000117,30,3,1000173,1000174,1000175,1000176,3,1000177,1000155,1000178,1000179,28,29,18,1000180,1000151,1000181,29,30,3,1000182,1000183,1000184,3,1000185,1000186,1000187,3,1000188,1000189,1000190,3,1000191,1000192,1000193,3,1000194,1000195,1000196,1000197,1000198,3,1000199,1000200,1000201,1000198,3,1000202,1000203,1000204,1000205,1000143,3,1000206,1000110,1000207,1000208,1000209,1000210,3,1000211,1000212,1000213,1000214,1000133,1000215,1000216,3,1000217,1000212,1000213,1000218,1000133,1000215,1000216,3]},{"originalStartLineNumberOneIndexed":114,"originalEndLineNumberExclusiveOneIndexed":114,"modifiedStartLineNumberOneIndexed":287,"modifiedEndLineNumberExclusiveOneIndexed":288,"addedLines":["      data: {"],"tokenizedAddedLines":[1000219]},{"originalStartLineNumberOneIndexed":119,"originalEndLineNumberExclusiveOneIndexed":119,"modifiedStartLineNumberOneIndexed":293,"modifiedEndLineNumberExclusiveOneIndexed":294,"addedLines":["          inscricoes: await prisma.oxetechwork_inscricao_alunos.count(),"],"tokenizedAddedLines":[1000220]},{"originalStartLineNumberOneIndexed":126,"originalEndLineNumberExclusiveOneIndexed":126,"modifiedStartLineNumberOneIndexed":301,"modifiedEndLineNumberExclusiveOneIndexed":316,"addedLines":["        vagas: vagasDetalhadas.map((vaga) => ({","          id: vaga.id,","          titulo: vaga.titulo,","          status: vaga.status,","          quantidade: vaga.quantidade,","          empresa: vaga.empresas?.razao_social || 'Sem empresa',","          totalCandidaturas: vaga.candidaturas.length,","          dataEncerramento: vaga.data_encerramento,","        })),","        temposMedios: {","          inscricaoCandidatura: Math.round(tempoMedioInscricaoCandidatura),","          candidaturaContratacao: Math.round(tempoMedioCandidaturaContratacao),","        },","      },","      error: null,"],"tokenizedAddedLines":[1000221,1000222,1000223,1000224,1000225,1000226,1000227,1000228,1000229,1000230,1000231,1000232,28,29,1000233]},{"originalStartLineNumberOneIndexed":130,"originalEndLineNumberExclusiveOneIndexed":131,"modifiedStartLineNumberOneIndexed":320,"modifiedEndLineNumberExclusiveOneIndexed":321,"addedLines":["      { data: null, error: 'Failed to fetch work data' },"],"tokenizedAddedLines":[1000234]},{"originalStartLineNumberOneIndexed":135,"originalEndLineNumberExclusiveOneIndexed":136,"modifiedStartLineNumberOneIndexed":325,"modifiedEndLineNumberExclusiveOneIndexed":325}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}
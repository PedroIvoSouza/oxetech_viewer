{"fsPath":"\\home\\oxetech_mcz\\app\\api\\lab\\agregado\\route.ts","fileUuid":"34e1af22-538a-4660-89a6-2dc44fd8de4c","fileSizeBytes":3310,"numLines":105,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":106,"addedLines":["/**"," * API de Dados Agregados do Lab"," * "," * Retorna dados agregados do CSV legado + banco de dados,"," * SEM alterar o banco original."," */","","import { NextResponse } from 'next/server'","import { agregarDadosLab } from '@/lib/data-aggregator/lab-aggregator'","","export const dynamic = 'force-dynamic'","","export async function GET(request: Request) {","  try {","    const { searchParams } = new URL(request.url)","    const usarIA = searchParams.get('sem-ia') !== 'true'","","    const turmasAgregadas = await agregarDadosLab(usarIA)","","    // Calcular estatísticas agregadas","    const totalTurmas = turmasAgregadas.length","    const totalInscritos = turmasAgregadas.reduce((acc, t) => acc + t.qtdVagasPreenchidas, 0)","    const totalFormados = turmasAgregadas.reduce((acc, t) => acc + t.numFormados, 0)","    const totalVagas = turmasAgregadas.reduce((acc, t) => acc + t.qtdVagasTotal, 0)","","    // Agrupar por laboratório","    const porLaboratorio = turmasAgregadas.reduce((acc, turma) => {","      const lab = turma.laboratorio","      if (!acc[lab]) {","        acc[lab] = {","          laboratorio: lab,","          totalTurmas: 0,","          totalInscritos: 0,","          totalFormados: 0,","          totalVagas: 0,","          turmas: [],","        }","      }","      acc[lab].totalTurmas++","      acc[lab].totalInscritos += turma.qtdVagasPreenchidas","      acc[lab].totalFormados += turma.numFormados","      acc[lab].totalVagas += turma.qtdVagasTotal","      acc[lab].turmas.push(turma)","      return acc","    }, {} as Record<string, any>)","","    // Agrupar por curso","    const porCurso = turmasAgregadas.reduce((acc, turma) => {","      const curso = turma.cursoNormalizado","      if (!acc[curso]) {","        acc[curso] = {","          curso,","          totalTurmas: 0,","          totalInscritos: 0,","          totalFormados: 0,","          totalVagas: 0,","          turmas: [],","        }","      }","      acc[curso].totalTurmas++","      acc[curso].totalInscritos += turma.qtdVagasPreenchidas","      acc[curso].totalFormados += turma.numFormados","      acc[curso].totalVagas += turma.qtdVagasTotal","      acc[curso].turmas.push(turma)","      return acc","    }, {} as Record<string, any>)","","    // Estatísticas de fontes","    const turmasApenasBanco = turmasAgregadas.filter((t) => t.fontes.length === 1 && t.fontes[0] === 'BANCO').length","    const turmasApenasCSV = turmasAgregadas.filter((t) => t.fontes.length === 1 && t.fontes[0] === 'CSV').length","    const turmasAmbas = turmasAgregadas.filter((t) => t.fontes.length === 2).length","","    return NextResponse.json({","      data: {","        estatisticas: {","          totalTurmas,","          totalInscritos,","          totalFormados,","          totalVagas,","          taxaEvasao: totalInscritos > 0 ? ((totalInscritos - totalFormados) / totalInscritos) * 100 : 0,","          porFonte: {","            apenasBanco: turmasApenasBanco,","            apenasCSV: turmasApenasCSV,","            ambas: turmasAmbas,","          },","        },","        turmas: turmasAgregadas,","        porLaboratorio: Object.values(porLaboratorio),","        porCurso: Object.values(porCurso),","      },","      error: null,","    })","  } catch (error: any) {","    console.error('Error aggregating lab data:', error)","    return NextResponse.json(","      {","        data: null,","        error: error?.message || 'Failed to aggregate lab data',","      },","      { status: 500 }","    )","  }","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000006,1000009,1000006,1000010,1000011,1000012,1000013,1000006,1000014,1000006,1000015,1000016,1000017,1000018,1000019,1000006,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000006,1000040,1000041,1000042,1000043,1000044,1000045,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000046,1000047,1000048,1000049,1000050,1000038,1000039,1000006,1000051,1000052,1000053,1000054,1000006,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000072,1000081,1000082,1000083,1000084,1000006,1000006]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
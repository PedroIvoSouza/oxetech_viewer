{"fsPath":"\\home\\oxetech_mcz\\docs\\AGREGACAO_DADOS.md","fileUuid":"e5defce6-f20b-4fd2-be12-43155280a97f","fileSizeBytes":6456,"numLines":250,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":251,"addedLines":["# Agregação de Dados - CSV + Banco","","## Visão Geral","","O sistema agora possui uma **camada de agregação** que combina dados do CSV legado com os dados do banco de dados **SEM alterar o banco original**. Toda a compatibilização é feita em memória, em tempo de execução.","","## Como Funciona","","### 1. Carregamento de Dados","","1. **CSV Legado**: Dados históricos do arquivo `/docs/Dashboard - OxeTech lab - Respostas ao formulário 1.csv`","   - Normalização de laboratórios","   - Correção de nomes de cursos com IA","   - Parse de datas e números","","2. **Banco de Dados**: Dados atuais do banco PostgreSQL","   - Turmas existentes","   - Matrículas e certificados","   - Dados de laboratórios","","### 2. Processo de Agregação","","1. **Merge Inteligente**: ","   - Identifica turmas similares (mesmo laboratório + curso + datas próximas)","   - Aplica prevalência: turma com maior número de formados prevalece","   - Combina dados das duas fontes","","2. **Sem Duplicação**:","   - Turmas do banco são mantidas","   - Turmas do CSV são adicionadas se não existirem no banco","   - Turmas duplicadas são mescladas com prevalência","","3. **Resultado**:","   - Lista agregada de todas as turmas","   - Estatísticas consolidadas","   - Dados normalizados e corrigidos","","## Estrutura de Dados Agregados","","```typescript","interface TurmaAgregada {","  id?: number              // ID do banco (se existir)","  titulo: string           // Nome do curso (corrigido pela IA)","  cursoNormalizado: string // Nome normalizado","  laboratorio: string      // Nome do laboratório","  dataInicio: Date","  dataEncerramento: Date","  qtdVagasTotal: number","  qtdVagasPreenchidas: number  // Matriculados (inscritos do CSV)","  numFormados: number","  taxaEvasao?: number","  fontes: ('CSV' | 'BANCO')[]  // Origem dos dados","  prevalencia: 'CSV' | 'BANCO' | 'AMBOS'  // Qual fonte prevaleceu","}","```","","## API","","### Endpoint: `/api/lab/agregado`","","Retorna dados agregados do CSV + banco de dados.","","**Query Parameters:**","- `sem-ia`: Se `true`, desabilita correção de nomes com IA (mais rápido)","","**Exemplo:**","```bash","GET /api/lab/agregado","GET /api/lab/agregado?sem-ia=true","```","","**Resposta:**","```json","{","  \"data\": {","    \"estatisticas\": {","      \"totalTurmas\": 635,","      \"totalInscritos\": 12500,","      \"totalFormados\": 8900,","      \"totalVagas\": 13000,","      \"taxaEvasao\": 28.8,","      \"porFonte\": {","        \"apenasBanco\": 142,","        \"apenasCSV\": 493,","        \"ambas\": 45","      }","    },","    \"turmas\": [...],","    \"porLaboratorio\": [...],","    \"porCurso\": [...]","  }","}","```","","## Interface de Usuário","","### Página: `/lab/agregado`","","Visualização completa dos dados agregados com:","- KPIs agregados","- Estatísticas por fonte (Banco/CSV/Ambas)","- Dados por laboratório","- Dados por curso","- Tabela com todas as turmas agregadas","","### Hook React Query: `useLabAgregado()`","","```typescript","import { useLabAgregado } from '@/lib/queries/lab-agregado'","","function MeuComponente() {","  const { data, isLoading, error } = useLabAgregado(false) // false = usar IA","  ","  // ...","}","```","","## Cache","","- **CSV**: Cacheado em memória após primeira leitura","- **Banco**: Sempre atualizado (queries diretas)","- **Agregação**: Calculada em tempo de execução (sempre fresca)","","Para limpar cache do CSV:","```typescript","import { limparCacheCSV } from '@/lib/data-aggregator/lab-aggregator'","","limparCacheCSV()","```","","## Vantagens","","### ✅ Banco Original Intacto","- Nenhuma alteração no banco de dados original","- Dados históricos preservados","- Sem risco de corrupção de dados","","### ✅ Dados Completos","- Combina histórico (CSV) com atual (Banco)","- Preenche lacunas de dados antigos","- Mantém dados atuais atualizados","","### ✅ Normalização Automática","- Nomes de cursos corrigidos com IA","- Laboratórios normalizados","- Datas e números padronizados","","### ✅ Prevalência Inteligente","- Turma com mais formados prevalece","- Evita perda de dados importantes","- Merge automático sem duplicação","","## Comparação: Banco Original vs Agregado","","| Aspecto | Banco Original | Dados Agregados |","|---------|---------------|-----------------|","| **Fonte** | Apenas banco PostgreSQL | CSV + Banco |","| **Alterações** | Pode ser modificado | Nunca alterado |","| **Dados Históricos** | Limitados ao que está no banco | CSV legado incluído |","| **Normalização** | Depende do banco | Automática com IA |","| **Prevalência** | N/A | Aplicada automaticamente |","| **Uso** | Dados operacionais | Visualização e análise |","","## Quando Usar","","### Use Dados Agregados Para:","- ✅ Visualizações e dashboards","- ✅ Análises históricas completas","- ✅ Relatórios executivos","- ✅ BI e métricas","- ✅ Comparações temporais","","### Use Banco Original Para:","- ✅ Operações do sistema (inscrições, matrículas)","- ✅ Dados em tempo real","- ✅ Modificações de dados","- ✅ Integrações com outros sistemas","","## Exemplos de Uso","","### 1. Página de Visualização","```typescript","// app/(dashboard)/lab/agregado/page.tsx","import { useLabAgregado } from '@/lib/queries/lab-agregado'","","export default function LabAgregadoPage() {","  const { data, isLoading } = useLabAgregado(false)","  ","  if (isLoading) return <Loading />","  ","  const stats = data?.data?.estatisticas","  const turmas = data?.data?.turmas","  ","  return (","    <div>","      <KPI value={stats?.totalTurmas} />","      <TurmasList turmas={turmas} />","    </div>","  )","}","```","","### 2. API Route Customizada","```typescript","// app/api/meus-dados/route.ts","import { agregarDadosLab } from '@/lib/data-aggregator/lab-aggregator'","","export async function GET() {","  const turmasAgregadas = await agregarDadosLab(true) // usar IA","  ","  // Processar dados agregados...","  ","  return NextResponse.json({ turmas: turmasAgregadas })","}","```","","## Performance","","- **Primeira carga**: ~2-5 segundos (corrige nomes com IA)","- **Carregamentos seguintes**: ~500ms-1s (cache do CSV)","- **Sem IA**: ~300-500ms (mais rápido, sem correção de nomes)","","## Manutenção","","### Atualizar CSV","1. Substitua o arquivo `/docs/Dashboard - OxeTech lab - Respostas ao formulário 1.csv`","2. Limpe o cache: `limparCacheCSV()`","3. Próxima requisição carregará o novo CSV","","### Adicionar Novos Dados","- **No banco**: Dados aparecem automaticamente na agregação","- **No CSV**: Substitua o arquivo e limpe o cache","","## Troubleshooting","","### Dados não atualizam","- Limpe o cache: `limparCacheCSV()`","- Verifique se o arquivo CSV foi atualizado","- Verifique se o banco tem dados novos","","### Performance lenta","- Use `sem-ia=true` para desabilitar correção de nomes","- Cache está funcionando? Verifique logs","","### Dados inconsistentes","- Verifique normalização de laboratórios","- Verifique correção de nomes com IA","- Revise lógica de prevalência","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000001,1000003,1000001,1000004,1000001,1000005,1000001,1000006,1000007,1000008,1000009,1000001,1000010,1000011,1000012,1000013,1000001,1000014,1000001,1000015,1000016,1000017,1000018,1000001,1000019,1000020,1000021,1000022,1000001,1000023,1000024,1000025,1000026,1000001,1000027,1000001,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000001,1000044,1000001,1000045,1000001,1000046,1000001,1000047,1000048,1000001,1000049,1000050,1000051,1000052,1000043,1000001,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000072,1000042,1000043,1000001,1000073,1000001,1000074,1000001,1000075,1000076,1000077,1000078,1000079,1000080,1000001,1000081,1000001,1000028,1000082,1000001,1000083,1000084,1000085,1000086,1000042,1000043,1000001,1000087,1000001,1000088,1000089,1000090,1000001,1000091,1000028,1000092,1000001,1000093,1000043,1000001,1000094,1000001,1000095,1000096,1000097,1000098,1000001,1000099,1000100,1000101,1000102,1000001,1000103,1000104,1000105,1000106,1000001,1000107,1000108,1000109,1000110,1000001,1000111,1000001,1000112,1000113,1000114,1000115,1000116,1000117,1000118,1000119,1000001,1000120,1000001,1000121,1000122,1000123,1000124,1000125,1000126,1000001,1000127,1000128,1000129,1000130,1000131,1000001,1000132,1000001,1000133,1000028,1000134,1000082,1000001,1000135,1000136,1000085,1000137,1000085,1000138,1000139,1000085,1000140,1000141,1000142,1000143,1000144,1000145,1000042,1000043,1000001,1000146,1000028,1000147,1000148,1000001,1000149,1000150,1000085,1000151,1000085,1000152,1000042,1000043,1000001,1000153,1000001,1000154,1000155,1000156,1000001,1000157,1000001,1000158,1000159,1000160,1000161,1000001,1000162,1000163,1000164,1000001,1000165,1000001,1000166,1000167,1000168,1000169,1000001,1000170,1000171,1000172,1000001,1000173,1000174,1000175,1000176,1000001,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
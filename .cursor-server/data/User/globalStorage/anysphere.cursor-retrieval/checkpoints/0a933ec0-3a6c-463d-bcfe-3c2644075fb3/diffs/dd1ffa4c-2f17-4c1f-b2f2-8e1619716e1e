{"fsPath":"\\home\\oxetech_mcz\\app\\(dashboard)\\lab\\agregado\\page.tsx","fileUuid":"dd1ffa4c-2f17-4c1f-b2f2-8e1619716e1e","fileSizeBytes":10778,"numLines":266,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":267,"addedLines":["/**"," * Página de Dados Agregados do Lab"," * "," * Mostra dados do CSV legado + banco de dados agregados,"," * SEM alterar o banco original."," */","","'use client'","","import { useLabAgregado } from '@/lib/queries/lab-agregado'","import { formatNumber } from '@/lib/formatters'","import { Award, Users, BookOpen, TrendingDown, Database, FileText, RefreshCw } from 'lucide-react'","import { KPICard } from '@/components/dashboard/kpi-card'","import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'","","export default function LabAgregadoPage() {","  const { data, isLoading, error, refetch } = useLabAgregado(false)","","  if (isLoading) {","    return (","      <div className=\"flex items-center justify-center h-64\">","        <RefreshCw className=\"h-8 w-8 animate-spin text-primary\" />","        <span className=\"ml-2\">Carregando dados agregados...</span>","      </div>","    )","  }","","  if (error) {","    return (","      <div className=\"p-6\">","        <div className=\"bg-destructive/10 border border-destructive/20 rounded-lg p-4\">","          <p className=\"text-destructive\">Erro ao carregar dados: {error.message}</p>","        </div>","      </div>","    )","  }","","  const stats = data?.data?.estatisticas","  const turmas = data?.data?.turmas || []","  const porLaboratorio = data?.data?.porLaboratorio || []","  const porCurso = data?.data?.porCurso || []","","  return (","    <div className=\"p-6 space-y-6\">","      <div className=\"flex items-center justify-between\">","        <div>","          <h1 className=\"text-3xl font-bold\">Lab - Dados Agregados</h1>","          <p className=\"text-muted-foreground mt-2\">","            Dados do CSV legado + banco de dados (banco original não é alterado)","          </p>","        </div>","        <button","          onClick={() => refetch()}","          className=\"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 flex items-center gap-2\"","        >","          <RefreshCw className=\"h-4 w-4\" />","          Atualizar","        </button>","      </div>","","      {/* KPIs */}","      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">","        <KPICard","          title=\"Total de Turmas\"","          value={formatNumber(stats?.totalTurmas || 0)}","          icon={BookOpen}","          description=\"CSV + Banco agregados\"","        />","        <KPICard","          title=\"Total de Matriculados\"","          value={formatNumber(stats?.totalInscritos || 0)}","          icon={Users}","          description=\"Inscritos agregados\"","        />","        <KPICard","          title=\"Total de Formados\"","          value={formatNumber(stats?.totalFormados || 0)}","          icon={Award}","          description=\"Certificados agregados\"","        />","        <KPICard","          title=\"Taxa de Evasão\"","          value={`${(stats?.taxaEvasao || 0).toFixed(1)}%`}","          icon={TrendingDown}","          description=\"Calculada dos dados agregados\"","        />","      </div>","","      {/* Estatísticas de Fontes */}","      <Card>","        <CardHeader>","          <CardTitle className=\"flex items-center gap-2\">","            <Database className=\"h-5 w-5\" />","            Fontes de Dados","          </CardTitle>","        </CardHeader>","        <CardContent>","          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">","            <div className=\"p-4 border rounded-lg\">","              <div className=\"flex items-center gap-2 mb-2\">","                <Database className=\"h-4 w-4 text-blue-500\" />","                <span className=\"font-semibold\">Apenas Banco</span>","              </div>","              <p className=\"text-2xl font-bold\">{formatNumber(stats?.porFonte?.apenasBanco || 0)}</p>","              <p className=\"text-sm text-muted-foreground\">Turmas existentes no banco</p>","            </div>","            <div className=\"p-4 border rounded-lg\">","              <div className=\"flex items-center gap-2 mb-2\">","                <FileText className=\"h-4 w-4 text-green-500\" />","                <span className=\"font-semibold\">Apenas CSV</span>","              </div>","              <p className=\"text-2xl font-bold\">{formatNumber(stats?.porFonte?.apenasCSV || 0)}</p>","              <p className=\"text-sm text-muted-foreground\">Turmas legadas do CSV</p>","            </div>","            <div className=\"p-4 border rounded-lg\">","              <div className=\"flex items-center gap-2 mb-2\">","                <Database className=\"h-4 w-4 text-purple-500\" />","                <FileText className=\"h-4 w-4 text-purple-500\" />","                <span className=\"font-semibold\">Ambas Fontes</span>","              </div>","              <p className=\"text-2xl font-bold\">{formatNumber(stats?.porFonte?.ambas || 0)}</p>","              <p className=\"text-sm text-muted-foreground\">Turmas duplicadas (merge aplicado)</p>","            </div>","          </div>","        </CardContent>","      </Card>","","      {/* Por Laboratório */}","      <Card>","        <CardHeader>","          <CardTitle>Por Laboratório</CardTitle>","        </CardHeader>","        <CardContent>","          <div className=\"space-y-4\">","            {porLaboratorio","              .sort((a, b) => b.totalFormados - a.totalFormados)","              .slice(0, 10)","              .map((lab, idx) => (","                <div key={idx} className=\"p-4 border rounded-lg\">","                  <div className=\"flex justify-between items-start mb-2\">","                    <h3 className=\"font-semibold\">{lab.laboratorio}</h3>","                    <span className=\"text-sm text-muted-foreground\">","                      {lab.totalTurmas} turma{lab.totalTurmas !== 1 ? 's' : ''}","                    </span>","                  </div>","                  <div className=\"grid grid-cols-3 gap-4 mt-2\">","                    <div>","                      <p className=\"text-sm text-muted-foreground\">Matriculados</p>","                      <p className=\"text-lg font-bold\">{formatNumber(lab.totalInscritos)}</p>","                    </div>","                    <div>","                      <p className=\"text-sm text-muted-foreground\">Formados</p>","                      <p className=\"text-lg font-bold text-green-600\">{formatNumber(lab.totalFormados)}</p>","                    </div>","                    <div>","                      <p className=\"text-sm text-muted-foreground\">Taxa Evasão</p>","                      <p className=\"text-lg font-bold\">","                        {lab.totalInscritos > 0","                          ? `${(((lab.totalInscritos - lab.totalFormados) / lab.totalInscritos) * 100).toFixed(1)}%`","                          : '0%'}","                      </p>","                    </div>","                  </div>","                </div>","              ))}","          </div>","        </CardContent>","      </Card>","","      {/* Por Curso */}","      <Card>","        <CardHeader>","          <CardTitle>Por Curso</CardTitle>","        </CardHeader>","        <CardContent>","          <div className=\"space-y-4\">","            {porCurso","              .sort((a, b) => b.totalFormados - a.totalFormados)","              .slice(0, 10)","              .map((curso, idx) => (","                <div key={idx} className=\"p-4 border rounded-lg\">","                  <div className=\"flex justify-between items-start mb-2\">","                    <h3 className=\"font-semibold\">{curso.curso}</h3>","                    <span className=\"text-sm text-muted-foreground\">","                      {curso.totalTurmas} turma{curso.totalTurmas !== 1 ? 's' : ''}","                    </span>","                  </div>","                  <div className=\"grid grid-cols-3 gap-4 mt-2\">","                    <div>","                      <p className=\"text-sm text-muted-foreground\">Matriculados</p>","                      <p className=\"text-lg font-bold\">{formatNumber(curso.totalInscritos)}</p>","                    </div>","                    <div>","                      <p className=\"text-sm text-muted-foreground\">Formados</p>","                      <p className=\"text-lg font-bold text-green-600\">{formatNumber(curso.totalFormados)}</p>","                    </div>","                    <div>","                      <p className=\"text-sm text-muted-foreground\">Taxa Evasão</p>","                      <p className=\"text-lg font-bold\">","                        {curso.totalInscritos > 0","                          ? `${(((curso.totalInscritos - curso.totalFormados) / curso.totalInscritos) * 100).toFixed(1)}%`","                          : '0%'}","                      </p>","                    </div>","                  </div>","                </div>","              ))}","          </div>","        </CardContent>","      </Card>","","      {/* Tabela de Turmas */}","      <Card>","        <CardHeader>","          <CardTitle>Todas as Turmas Agregadas</CardTitle>","        </CardHeader>","        <CardContent>","          <div className=\"overflow-x-auto\">","            <table className=\"w-full text-sm\">","              <thead>","                <tr className=\"border-b\">","                  <th className=\"text-left p-2\">Curso</th>","                  <th className=\"text-left p-2\">Laboratório</th>","                  <th className=\"text-center p-2\">Início</th>","                  <th className=\"text-center p-2\">Matriculados</th>","                  <th className=\"text-center p-2\">Formados</th>","                  <th className=\"text-center p-2\">Fontes</th>","                </tr>","              </thead>","              <tbody>","                {turmas","                  .sort((a, b) => new Date(b.dataInicio).getTime() - new Date(a.dataInicio).getTime())","                  .slice(0, 50)","                  .map((turma, idx) => (","                    <tr key={idx} className=\"border-b hover:bg-muted/50\">","                      <td className=\"p-2\">{turma.titulo}</td>","                      <td className=\"p-2\">{turma.laboratorio}</td>","                      <td className=\"p-2 text-center\">","                        {new Date(turma.dataInicio).toLocaleDateString('pt-BR')}","                      </td>","                      <td className=\"p-2 text-center\">{formatNumber(turma.qtdVagasPreenchidas)}</td>","                      <td className=\"p-2 text-center text-green-600 font-semibold\">","                        {formatNumber(turma.numFormados)}","                      </td>","                      <td className=\"p-2 text-center\">","                        <div className=\"flex items-center justify-center gap-1\">","                          {turma.fontes.includes('BANCO') && (","                            <span className=\"px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs\">Banco</span>","                          )}","                          {turma.fontes.includes('CSV') && (","                            <span className=\"px-2 py-1 bg-green-100 text-green-700 rounded text-xs\">CSV</span>","                          )}","                        </div>","                      </td>","                    </tr>","                  ))}","              </tbody>","            </table>","          </div>","        </CardContent>","      </Card>","    </div>","  )","}","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000006,1000008,1000009,1000010,1000011,1000012,1000006,1000013,1000014,1000006,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000006,1000023,1000016,1000024,1000025,1000026,1000027,1000020,1000021,1000022,1000006,1000028,1000029,1000030,1000031,1000006,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000027,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000020,1000006,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000049,1000055,1000056,1000057,1000058,1000054,1000049,1000059,1000060,1000061,1000062,1000054,1000049,1000063,1000064,1000065,1000066,1000054,1000020,1000006,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000077,1000078,1000085,1000086,1000081,1000087,1000088,1000084,1000077,1000078,1000089,1000090,1000091,1000081,1000092,1000093,1000084,1000094,1000095,1000096,1000006,1000097,1000068,1000069,1000098,1000074,1000075,1000099,1000100,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000108,1000109,1000110,1000111,1000112,1000113,1000114,1000115,1000112,1000116,1000117,1000115,1000112,1000118,1000119,1000120,1000121,1000122,1000123,1000115,1000110,1000124,1000125,1000094,1000095,1000096,1000006,1000126,1000068,1000069,1000127,1000074,1000075,1000099,1000128,1000101,1000102,1000129,1000104,1000105,1000130,1000107,1000131,1000109,1000110,1000111,1000112,1000113,1000132,1000115,1000112,1000116,1000133,1000115,1000112,1000118,1000119,1000134,1000135,1000122,1000123,1000115,1000110,1000124,1000125,1000094,1000095,1000096,1000006,1000136,1000068,1000069,1000137,1000074,1000075,1000138,1000139,1000140,1000141,1000142,1000143,1000144,1000145,1000146,1000147,1000148,1000149,1000150,1000151,1000152,1000153,1000154,1000155,1000156,1000157,1000158,1000159,1000160,1000161,1000162,1000163,1000160,1000158,1000164,1000165,1000166,1000167,1000168,1000169,1000167,1000170,1000160,1000171,1000172,1000173,1000174,1000094,1000095,1000096,1000175,1000176,1000177,1000006,1000006]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
{"fsPath":"\\home\\oxetech_mcz\\scripts\\importar-csv-lab.ts","fileUuid":"5f453495-3049-45f7-b2ee-8e3b6f395aef","fileSizeBytes":8735,"numLines":276,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":277,"addedLines":["/**"," * Script de Importa√ß√£o/Atualiza√ß√£o de Dados Legados do Lab"," * "," * Este script importa os dados do CSV legado para o banco de dados,"," * criando/atualizando turmas e matr√≠culas conforme necess√°rio."," * "," * USO:"," *   npx tsx scripts/importar-csv-lab.ts [--dry-run]"," * "," * Se --dry-run for passado, apenas simula sem fazer altera√ß√µes no banco."," */","","import { PrismaClient } from '@prisma/client'","import { parse } from 'csv-parse/sync'","import { readFileSync } from 'fs'","import { join } from 'path'","import { normalizarCurso } from '../lib/course-normalizer'","import { compatibilizarDados, processarCSV, buscarTurmasBanco } from './compatibilizar-csv-lab'","","const prisma = new PrismaClient()","","interface TurmaNormalizada {","  laboratorioNormalizado: string","  cursoNormalizado: string","  dataInicio: Date","  dataEncerramento: Date","  numInscritos: number","  numFormados: number","  taxaEvasao: number","  fonte: 'CSV' | 'BANCO'","  turmaId?: number","  // Dados originais do CSV para refer√™ncia","  original?: {","    laboratorio: string","    curso: string","    dataInicioStr: string","    dataEncerramentoStr: string","  }","}","","// Encontrar ou criar laborat√≥rio","async function encontrarOuCriarLaboratorio(","  nomeNormalizado: string,","  dryRun: boolean = false","): Promise<number> {","  let laboratorio = await prisma.laboratorios.findFirst({","    where: {","      nome: {","        contains: nomeNormalizado,","        mode: 'insensitive',","      },","    },","  })","","  if (!laboratorio) {","    console.log(`   ‚ö†Ô∏è  Laborat√≥rio \"${nomeNormalizado}\" n√£o encontrado. Criando...`)","    ","    if (dryRun) {","      console.log(`   [DRY-RUN] Criaria laborat√≥rio: ${nomeNormalizado}`)","      return -1 // ID fict√≠cio para dry-run","    }","","    // Buscar coordenador padr√£o (primeiro aluno ou criar placeholder)","    const coordenadorPadrao = await prisma.alunos.findFirst()","    if (!coordenadorPadrao) {","      throw new Error('Nenhum aluno encontrado. √â necess√°rio ter pelo menos um aluno no banco.')","    }","","    laboratorio = await prisma.laboratorios.create({","      data: {","        nome: nomeNormalizado,","        municipio: nomeNormalizado.includes('Macei√≥') ? 'Macei√≥' : nomeNormalizado.split(' - ')[0] || nomeNormalizado,","        rua: 'A definir',","        bairro: 'A definir',","        numero: '0',","        cep: '57000000',","        complemento: '',","        coordenador_id: coordenadorPadrao.id,","        created_at: new Date(),","        updated_at: new Date(),","      },","    })","","    console.log(`   ‚úÖ Laborat√≥rio criado: ${laboratorio.nome} (ID: ${laboratorio.id})`)","  }","","  return laboratorio.id","}","","// Encontrar ou criar turma","async function encontrarOuCriarTurma(","  turmaCSV: TurmaNormalizada,","  laboratorioId: number,","  dryRun: boolean = false","): Promise<number> {","  // Buscar turma existente similar","  const turmasExistentes = await prisma.turmas.findMany({","    where: {","      laboratorio_id: laboratorioId,","      titulo: {","        contains: turmaCSV.cursoNormalizado,","        mode: 'insensitive',","      },","      data_inicio: {","        gte: new Date(turmaCSV.dataInicio.getTime() - 30 * 24 * 60 * 60 * 1000), // -30 dias","        lte: new Date(turmaCSV.dataInicio.getTime() + 30 * 24 * 60 * 60 * 1000), // +30 dias","      },","    },","    include: {","      matriculas: {","        where: {","          status: 'TWO', // APROVADO","        },","      },","    },","  })","","  // Verificar se existe turma similar","  let turmaExistente = turmasExistentes.find((t) => {","    const diffInicio = Math.abs(t.data_inicio.getTime() - turmaCSV.dataInicio.getTime()) / (1000 * 60 * 60 * 24)","    const diffFim = Math.abs(t.data_encerramento.getTime() - turmaCSV.dataEncerramento.getTime()) / (1000 * 60 * 60 * 24)","    return diffInicio <= 30 && diffFim <= 30","  })","","  if (turmaExistente) {","    const numFormadosBanco = turmaExistente.matriculas.length","","    // Se CSV tem mais formados, precisamos atualizar (mas n√£o atualizamos a turma em si,","    // apenas criamos as matr√≠culas faltantes)","    if (turmaCSV.numFormados > numFormadosBanco) {","      console.log(","        `   ‚ö†Ô∏è  Turma existente encontrada (ID: ${turmaExistente.id}), mas CSV tem mais formados.\\n` +","        `      Banco: ${numFormadosBanco} | CSV: ${turmaCSV.numFormados}\\n` +","        `      ‚Üí Ser√° necess√°rio criar ${turmaCSV.numFormados - numFormadosBanco} matr√≠culas adicionais.`","      )","      return turmaExistente.id","    }","","    console.log(`   ‚ÑπÔ∏è  Turma existente encontrada (ID: ${turmaExistente.id}) - mantendo dados do banco`)","    return turmaExistente.id","  }","","  // Criar nova turma","  console.log(`   ‚ûï Criando nova turma: ${turmaCSV.cursoNormalizado}`)","","  if (dryRun) {","    console.log(`   [DRY-RUN] Criaria turma: ${turmaCSV.cursoNormalizado}`)","    return -1","  }","","  const novaTurma = await prisma.turmas.create({","    data: {","      titulo: turmaCSV.original?.curso || turmaCSV.cursoNormalizado,","      descricao: `Turma importada do CSV legado`,","      info_adicionais: `Fonte: CSV legado | Inscritos: ${turmaCSV.numInscritos} | Formados: ${turmaCSV.numFormados}`,","      data_inicio: turmaCSV.dataInicio,","      data_encerramento: turmaCSV.dataEncerramento,","      data_encerramento_inscricoes: turmaCSV.dataEncerramento,","      status: 'ZERO', // Ativa","      qtd_vagas_total: turmaCSV.numInscritos,","      qtd_vagas_preenchidas: turmaCSV.numInscritos,","      qtd_vagas_disponiveis: 0,","      carga_horaria: 40, // Valor padr√£o - ajustar se necess√°rio","      qtd_aulas: 10, // Valor padr√£o - ajustar se necess√°rio","      perguntas: [],","      laboratorio_id: laboratorioId,","      created_at: new Date(),","      updated_at: new Date(),","    },","  })","","  console.log(`   ‚úÖ Turma criada: ${novaTurma.titulo} (ID: ${novaTurma.id})`)","  return novaTurma.id","}","","// Importar/Atualizar dados","async function importarDados(dryRun: boolean = false) {","  console.log('üîÑ Iniciando importa√ß√£o de dados legados...\\n')","  ","  if (dryRun) {","    console.log('‚ö†Ô∏è  MODO DRY-RUN: Nenhuma altera√ß√£o ser√° feita no banco de dados\\n')","  }","","  // 1. Compatibilizar dados","  const { turmasParaImportar, turmasParaAtualizar, relatorio } = await compatibilizarDados()","","  console.log('\\n' + '='.repeat(60))","  console.log('üì• INICIANDO IMPORTA√á√ÉO')","  console.log('='.repeat(60) + '\\n')","","  let turmasCriadas = 0","  let turmasAtualizadas = 0","  let erros = 0","","  // 2. Processar turmas para importar","  console.log(`\\nüì¶ Importando ${turmasParaImportar.length} novas turmas...\\n`)","","  for (const turmaCSV of turmasParaImportar) {","    try {","      console.log(`\\nüìù Processando: ${turmaCSV.laboratorioNormalizado} - ${turmaCSV.cursoNormalizado}`)","","      // Encontrar ou criar laborat√≥rio","      const laboratorioId = await encontrarOuCriarLaboratorio(","        turmaCSV.laboratorioNormalizado,","        dryRun","      )","","      if (laboratorioId === -1 && dryRun) {","        turmasCriadas++","        continue","      }","","      // Encontrar ou criar turma","      const turmaId = await encontrarOuCriarTurma(turmaCSV, laboratorioId, dryRun)","","      if (turmaId !== -1) {","        turmasCriadas++","      }","","      // NOTA: Para criar matr√≠culas, seria necess√°rio ter dados dos alunos no CSV.","      // Como o CSV s√≥ tem n√∫meros agregados, n√£o podemos criar matr√≠culas individuais.","      // Isso precisaria ser feito manualmente ou com outro arquivo CSV com dados de alunos.","      console.log(","        `   ‚ö†Ô∏è  NOTA: Matr√≠culas n√£o podem ser criadas automaticamente sem dados dos alunos.\\n` +","        `      Turma criada/atualizada com ${turmaCSV.numFormados} formados registrados no CSV.`","      )","    } catch (error) {","      console.error(`   ‚ùå Erro ao processar turma:`, error)","      erros++","    }","  }","","  // 3. Processar turmas para atualizar (j√° foi feito na compatibiliza√ß√£o, apenas logar)","  console.log(`\\nüìù Turmas para atualizar: ${turmasParaAtualizar.size}`)","  console.log('   ‚ÑπÔ∏è  Turmas duplicadas foram analisadas na fase de compatibiliza√ß√£o.')","  console.log('   ‚ÑπÔ∏è  Para criar matr√≠culas adicionais, use dados dos alunos individuais.')","","  // Resumo final","  console.log('\\n' + '='.repeat(60))","  console.log('‚úÖ IMPORTA√á√ÉO CONCLU√çDA')","  console.log('='.repeat(60))","  console.log(`   Turmas criadas: ${turmasCriadas}`)","  console.log(`   Turmas atualizadas: ${turmasParaAtualizar.size}`)","  console.log(`   Erros: ${erros}`)","  ","  if (dryRun) {","    console.log('\\n‚ö†Ô∏è  MODO DRY-RUN: Nenhuma altera√ß√£o foi feita no banco de dados')","    console.log('   Execute sem --dry-run para aplicar as mudan√ßas.')","  }","","  console.log('')","}","","// Executar script","async function main() {","  const args = process.argv.slice(2)","  const dryRun = args.includes('--dry-run')","","  try {","    await importarDados(dryRun)","    await prisma.$disconnect()","  } catch (error) {","    console.error('‚ùå Erro:', error)","    await prisma.$disconnect()","    process.exit(1)","  }","}","","// Executar se chamado diretamente","if (require.main === module) {","  main()","}","","export { importarDados }","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000002,1000005,1000006,1000002,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000009,1000016,1000009,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000009,1000035,1000036,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000009,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000009,1000055,1000056,1000057,1000058,1000054,1000009,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000069,1000070,1000045,1000071,1000009,1000072,1000033,1000009,1000073,1000034,1000009,1000074,1000075,1000076,1000077,1000038,1000039,1000078,1000079,1000041,1000080,1000081,1000082,1000044,1000045,1000083,1000084,1000085,1000045,1000046,1000086,1000087,1000088,1000089,1000090,1000045,1000046,1000047,1000009,1000091,1000092,1000093,1000094,1000095,1000047,1000009,1000096,1000097,1000009,1000098,1000099,1000100,1000101,1000102,1000103,1000104,1000105,1000106,1000054,1000009,1000107,1000108,1000033,1000009,1000109,1000110,1000009,1000111,1000112,1000113,1000033,1000009,1000114,1000115,1000116,1000117,1000118,1000119,1000120,1000121,1000122,1000123,1000124,1000125,1000126,1000127,1000128,1000080,1000129,1000130,1000046,1000047,1000009,1000131,1000132,1000034,1000009,1000133,1000134,1000135,1000136,1000111,1000137,1000033,1000009,1000138,1000139,1000009,1000140,1000141,1000142,1000009,1000143,1000144,1000145,1000009,1000146,1000147,1000009,1000148,1000149,1000150,1000009,1000151,1000152,1000153,1000154,1000105,1000009,1000155,1000156,1000157,1000158,1000009,1000159,1000160,1000009,1000161,1000156,1000158,1000009,1000162,1000163,1000164,1000101,1000165,1000166,1000105,1000167,1000168,1000169,1000054,1000033,1000009,1000170,1000171,1000172,1000173,1000009,1000174,1000140,1000175,1000176,1000177,1000178,1000179,1000136,1000111,1000180,1000181,1000033,1000009,1000182,1000034,1000009,1000183,1000184,1000185,1000186,1000009,1000187,1000188,1000189,1000190,1000191,1000189,1000192,1000033,1000034,1000009,1000193,1000194,1000195,1000034,1000009,1000196,1000009,1000009]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
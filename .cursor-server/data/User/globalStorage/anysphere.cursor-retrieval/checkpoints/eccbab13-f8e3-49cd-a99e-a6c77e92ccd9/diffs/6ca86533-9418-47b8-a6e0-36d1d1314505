{"fsPath":"\\home\\oxetech_mcz\\scripts\\compatibilizar-csv-lab.ts","fileUuid":"6ca86533-9418-47b8-a6e0-36d1d1314505","fileSizeBytes":10679,"numLines":339,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":340,"addedLines":["/**"," * Script de Compatibiliza√ß√£o de Dados Legados do Lab"," * "," * Este script integra os dados do CSV legado com o banco de dados,"," * evitando duplica√ß√µes e prevalecendo a turma com maior n√∫mero de formados."," */","","import { PrismaClient } from '@prisma/client'","import { parse } from 'csv-parse/sync'","import { readFileSync } from 'fs'","import { join } from 'path'","import { normalizarCurso } from '../lib/course-normalizer'","","const prisma = new PrismaClient()","","interface CSVRow {","  carimboDataHora: string","  laboratorio: string","  curso: string","  dataInicio: string","  dataEncerramento: string","  numAlunosInscritos: number","  numAlunosFormados: number","  taxaEvasao: string","}","","interface TurmaNormalizada {","  laboratorioNormalizado: string","  cursoNormalizado: string","  dataInicio: Date","  dataEncerramento: Date","  numInscritos: number","  numFormados: number","  taxaEvasao: number","  fonte: 'CSV' | 'BANCO'","  turmaId?: number // Se existe no banco","  // Dados originais do CSV para refer√™ncia","  original?: {","    laboratorio: string","    curso: string","    dataInicioStr: string","    dataEncerramentoStr: string","  }","}","","// Mapeamento de nomes de laborat√≥rios do CSV para o banco","const normalizarLaboratorio = (nome: string): string => {","  const mapa: Record<string, string> = {","    'macei√≥ - centro de inova√ß√£o': 'Macei√≥ - Centro de Inova√ß√£o',","    'maceio - centro de inova√ß√£o': 'Macei√≥ - Centro de Inova√ß√£o',","    'macei√≥ - benedito bentes': 'Macei√≥ - Benedito Bentes',","    'maceio - benedito bentes': 'Macei√≥ - Benedito Bentes',","    'santana do ipanema': 'Santana do Ipanema',","    's√£o miguel dos campos': 'S√£o Miguel dos Campos',","    'sao miguel dos campos': 'S√£o Miguel dos Campos',","    'p√£o de a√ßucar': 'P√£o de A√ßucar',","    'pao de a√ßucar': 'P√£o de A√ßucar',","    'p√£o de acucar': 'P√£o de A√ßucar',","    'pao de acucar': 'P√£o de A√ßucar',","  }","","  const normalizado = nome.trim().toLowerCase()","  return mapa[normalizado] || nome.trim()","}","","// Parse de data brasileira (DD/MM/YYYY)","function parseDataBR(dataStr: string): Date {","  const [dia, mes, ano] = dataStr.split('/').map(Number)","  ","  // Corrigir datas inv√°lidas (ex: 03/04/1901)","  if (ano < 2000 || ano > 2100) {","    console.warn(`‚ö†Ô∏è  Data inv√°lida detectada: ${dataStr}. Usando data atual.`)","    return new Date()","  }","  ","  return new Date(ano, mes - 1, dia)","}","","// Comparar duas datas (diferen√ßa em dias)","function compararDatas(data1: Date, data2: Date, toleranciaDias: number = 30): boolean {","  const diff = Math.abs(data1.getTime() - data2.getTime())","  const diffDias = diff / (1000 * 60 * 60 * 24)","  return diffDias <= toleranciaDias","}","","// Verificar se duas turmas s√£o similares (mesmo laborat√≥rio + curso + datas pr√≥ximas)","function turmasSimilares(","  turma1: TurmaNormalizada,","  turma2: TurmaNormalizada,","  toleranciaDias: number = 30","): boolean {","  return (","    turma1.laboratorioNormalizado.toLowerCase() === turma2.laboratorioNormalizado.toLowerCase() &&","    turma1.cursoNormalizado.toLowerCase() === turma2.cursoNormalizado.toLowerCase() &&","    compararDatas(turma1.dataInicio, turma2.dataInicio, toleranciaDias) &&","    compararDatas(turma1.dataEncerramento, turma2.dataEncerramento, toleranciaDias)","  )","}","","// Ler e processar CSV","async function processarCSV(): Promise<TurmaNormalizada[]> {","  const csvPath = join(process.cwd(), 'docs', 'Dashboard - OxeTech lab - Respostas ao formul√°rio 1.csv')","  const csvContent = readFileSync(csvPath, 'utf-8')","","  const records = parse(csvContent, {","    columns: true,","    skip_empty_lines: true,","    bom: true,","    trim: true,","    relax_quotes: true,","    relax_column_count: true,","  }) as Record<string, string>[]","","  const turmas: TurmaNormalizada[] = []","","  for (const row of records) {","    try {","      // Pular linhas vazias ou inv√°lidas","      const laboratorio = row['Laborat√≥rio'] || row.laboratorio || ''","      const curso = row['Curso'] || row.curso || ''","      const dataInicioStr = row['Data de in√≠cio'] || ''","      const dataEncerramentoStr = row['Data de encerramento'] || ''","","      if (!laboratorio || !curso || !dataInicioStr) {","        continue","      }","","      const laboratorioNormalizado = normalizarLaboratorio(laboratorio)","      const cursoNormalizadoObj = normalizarCurso(curso)","      const dataInicio = parseDataBR(dataInicioStr)","      const dataEncerramento = parseDataBR(dataEncerramentoStr)","","      // Parse de n√∫meros","      const numInscritosStr = row['N√∫mero de alunos inscritos'] || ''","      const numFormadosStr = row['N√∫mero de alunos formados (Certificados entregues)'] || ''","      const numInscritos = parseInt(numInscritosStr) || 0","      const numFormados = parseInt(numFormadosStr) || 0","      ","      // Parse taxa de evas√£o (remover %)","      const taxaEvasaoStr = (row['Taxa de Evas√£o'] || '').replace('%', '').trim() || '0'","      const taxaEvasao = parseFloat(taxaEvasaoStr) || 0","","      turmas.push({","        laboratorioNormalizado,","        cursoNormalizado: cursoNormalizadoObj.nomeNormalizado,","        dataInicio,","        dataEncerramento,","        numInscritos,","        numFormados,","        taxaEvasao,","        fonte: 'CSV',","        original: {","          laboratorio,","          curso,","          dataInicioStr,","          dataEncerramentoStr,","        },","      })","    } catch (error) {","      console.error(`Erro ao processar linha:`, row, error)","    }","  }","","  return turmas","}","","// Buscar turmas existentes no banco","async function buscarTurmasBanco(): Promise<Map<number, TurmaNormalizada>> {","  const turmas = await prisma.turmas.findMany({","    include: {","      laboratorios: {","        select: {","          nome: true,","        },","      },","      matriculas: {","        where: {","          status: 'TWO', // APROVADO = Certificado","        },","      },","    },","  })","","  const turmasMap = new Map<number, TurmaNormalizada>()","","  for (const turma of turmas) {","    const cursoNormalizadoObj = normalizarCurso(turma.titulo)","    const numFormados = turma.matriculas.length // Matr√≠culas com status TWO","","    turmasMap.set(turma.id, {","      laboratorioNormalizado: turma.laboratorios.nome,","      cursoNormalizado: cursoNormalizadoObj.nomeNormalizado,","      dataInicio: turma.data_inicio,","      dataEncerramento: turma.data_encerramento,","      numInscritos: turma.qtd_vagas_preenchidas || 0,","      numFormados,","      taxaEvasao: 0, // Calcular se necess√°rio","      fonte: 'BANCO',","      turmaId: turma.id,","    })","  }","","  return turmasMap","}","","// Encontrar laborat√≥rio no banco","async function encontrarLaboratorio(nomeNormalizado: string): Promise<number | null> {","  const laboratorio = await prisma.laboratorios.findFirst({","    where: {","      nome: {","        contains: nomeNormalizado,","        mode: 'insensitive',","      },","    },","  })","","  return laboratorio?.id || null","}","","// Compatibilizar dados","async function compatibilizarDados() {","  console.log('üîÑ Iniciando compatibiliza√ß√£o de dados legados...\\n')","","  // 1. Processar CSV","  console.log('üìÑ Processando CSV...')","  const turmasCSV = await processarCSV()","  console.log(`‚úÖ ${turmasCSV.length} turmas encontradas no CSV\\n`)","","  // 2. Buscar turmas do banco","  console.log('üîç Buscando turmas no banco de dados...')","  const turmasBanco = await buscarTurmasBanco()","  console.log(`‚úÖ ${turmasBanco.size} turmas encontradas no banco\\n`)","","  // 3. Comparar e identificar duplicatas","  console.log('üîç Comparando turmas...')","  const turmasParaImportar: TurmaNormalizada[] = []","  const turmasParaAtualizar: Map<number, TurmaNormalizada> = new Map()","  const turmasDuplicadas: Array<{ csv: TurmaNormalizada; banco: TurmaNormalizada }> = []","","  for (const turmaCSV of turmasCSV) {","    let encontrada = false","","    // Procurar turma similar no banco","    for (const [turmaId, turmaBanco] of Array.from(turmasBanco.entries())) {","      if (turmasSimilares(turmaCSV, turmaBanco, 30)) {","        encontrada = true","        turmasDuplicadas.push({ csv: turmaCSV, banco: turmaBanco })","","        // Prevalecer a turma com maior n√∫mero de formados","        if (turmaCSV.numFormados > turmaBanco.numFormados) {","          console.log(","            `‚ö†Ô∏è  Duplicata encontrada: ${turmaCSV.laboratorioNormalizado} - ${turmaCSV.cursoNormalizado}\\n` +","            `   CSV: ${turmaCSV.numFormados} formados | Banco: ${turmaBanco.numFormados} formados\\n` +","            `   ‚Üí CSV prevalece (mais formados)`","          )","          turmasParaAtualizar.set(turmaId, turmaCSV)","        } else {","          console.log(","            `‚ÑπÔ∏è  Duplicata encontrada: ${turmaCSV.laboratorioNormalizado} - ${turmaCSV.cursoNormalizado}\\n` +","            `   CSV: ${turmaCSV.numFormados} formados | Banco: ${turmaBanco.numFormados} formados\\n` +","            `   ‚Üí Banco prevalece (mais formados)`","          )","        }","        break","      }","    }","","    // Se n√£o encontrou, adicionar para importar","    if (!encontrada) {","      turmasParaImportar.push(turmaCSV)","    }","  }","","  console.log(`\\nüìä Resumo:`)","  console.log(`   - Turmas no CSV: ${turmasCSV.length}`)","  console.log(`   - Turmas no banco: ${turmasBanco.size}`)","  console.log(`   - Duplicatas encontradas: ${turmasDuplicadas.length}`)","  console.log(`   - Turmas para importar: ${turmasParaImportar.length}`)","  console.log(`   - Turmas para atualizar: ${turmasParaAtualizar.size}\\n`)","","  // 4. Gerar relat√≥rio","  console.log('üìù Gerando relat√≥rio...')","  const relatorio = {","    totalCSV: turmasCSV.length,","    totalBanco: turmasBanco.size,","    duplicatas: turmasDuplicadas.length,","    paraImportar: turmasParaImportar.length,","    paraAtualizar: turmasParaAtualizar.size,","    detalhes: {","      duplicatas: turmasDuplicadas.map((d) => ({","        laboratorio: d.csv.laboratorioNormalizado,","        curso: d.csv.cursoNormalizado,","        csvFormados: d.csv.numFormados,","        bancoFormados: d.banco.numFormados,","        prevaleceu: d.csv.numFormados > d.banco.numFormados ? 'CSV' : 'BANCO',","      })),","      paraImportar: turmasParaImportar.map((t) => ({","        laboratorio: t.laboratorioNormalizado,","        curso: t.cursoNormalizado,","        numFormados: t.numFormados,","      })),","    },","  }","","  console.log('\\nüìã Relat√≥rio gerado:')","  console.log(JSON.stringify(relatorio, null, 2))","","  return {","    turmasParaImportar,","    turmasParaAtualizar,","    relatorio,","  }","}","","// Executar script","async function main() {","  try {","    const resultado = await compatibilizarDados()","","    console.log('\\n‚úÖ Compatibiliza√ß√£o conclu√≠da!')","    console.log('\\n‚ö†Ô∏è  NOTA: Este script apenas identifica diferen√ßas.')","    console.log('   Para importar/atualizar, execute o script de importa√ß√£o.\\n')","","    await prisma.$disconnect()","  } catch (error) {","    console.error('‚ùå Erro:', error)","    await prisma.$disconnect()","    process.exit(1)","  }","}","","// Executar se chamado diretamente","if (require.main === module) {","  main()","}","","export { compatibilizarDados, processarCSV, buscarTurmasBanco }","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000006,1000012,1000006,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000006,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000022,1000006,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000039,1000006,1000054,1000055,1000022,1000006,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000039,1000059,1000064,1000022,1000006,1000065,1000066,1000067,1000068,1000069,1000022,1000006,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000022,1000006,1000082,1000083,1000084,1000085,1000006,1000086,1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000006,1000094,1000006,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000006,1000102,1000103,1000104,1000006,1000105,1000106,1000107,1000108,1000006,1000109,1000110,1000111,1000112,1000113,1000114,1000115,1000116,1000117,1000006,1000118,1000119,1000120,1000121,1000122,1000123,1000124,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000132,1000133,1000134,1000135,1000136,1000039,1000006,1000137,1000022,1000006,1000138,1000139,1000140,1000141,1000142,1000143,1000144,1000132,1000145,1000146,1000147,1000148,1000132,1000145,1000149,1000150,1000006,1000151,1000006,1000152,1000153,1000154,1000006,1000155,1000156,1000157,1000158,1000159,1000160,1000161,1000162,1000163,1000164,1000165,1000039,1000006,1000166,1000022,1000006,1000167,1000168,1000169,1000170,1000171,1000172,1000173,1000145,1000149,1000150,1000006,1000174,1000022,1000006,1000175,1000176,1000177,1000006,1000178,1000179,1000180,1000181,1000006,1000182,1000183,1000184,1000185,1000006,1000186,1000187,1000188,1000189,1000190,1000006,1000191,1000192,1000006,1000193,1000194,1000195,1000196,1000197,1000006,1000198,1000199,1000200,1000201,1000202,1000203,1000204,1000205,1000206,1000200,1000207,1000202,1000208,1000204,1000209,1000210,1000104,1000136,1000006,1000211,1000212,1000213,1000136,1000039,1000006,1000214,1000215,1000216,1000217,1000218,1000219,1000006,1000220,1000221,1000222,1000223,1000224,1000225,1000226,1000227,1000228,1000229,1000230,1000231,1000232,1000233,1000234,1000235,1000236,1000237,1000238,1000239,1000235,1000149,1000039,1000006,1000240,1000241,1000006,1000242,1000243,1000244,1000245,1000039,1000022,1000006,1000246,1000247,1000248,1000249,1000006,1000250,1000251,1000252,1000006,1000253,1000254,1000255,1000253,1000256,1000039,1000022,1000006,1000257,1000258,1000259,1000022,1000006,1000260,1000006,1000006]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
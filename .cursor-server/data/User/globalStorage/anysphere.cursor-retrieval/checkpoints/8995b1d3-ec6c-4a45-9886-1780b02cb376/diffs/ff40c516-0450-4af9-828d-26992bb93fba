{"fsPath":"\\home\\oxetech_mcz\\app\\api\\lab\\route.ts","fileUuid":"ff40c516-0450-4af9-828d-26992bb93fba","fileSizeBytes":11865,"numLines":368,"diffChanges":[{"originalStartLineNumberOneIndexed":3,"originalEndLineNumberExclusiveOneIndexed":3,"modifiedStartLineNumberOneIndexed":3,"modifiedEndLineNumberExclusiveOneIndexed":4,"addedLines":["import { categorizarCursos } from '@/lib/course-normalizer'"],"tokenizedAddedLines":[1000196]},{"originalStartLineNumberOneIndexed":8,"originalEndLineNumberExclusiveOneIndexed":9,"modifiedStartLineNumberOneIndexed":9,"modifiedEndLineNumberExclusiveOneIndexed":42,"addedLines":["    // BUSCAR TURMAS ÚNICAS primeiro para calcular vagas corretamente","    const turmas = await prisma.turmas.findMany({","      select: {","        id: true,","        titulo: true,","        qtd_vagas_total: true,","        qtd_vagas_preenchidas: true,","        laboratorios: {","          select: {","            id: true,","            nome: true,","            municipio: true,","          },","        },","        oxetechlab_inscricoes: {","          select: {","            id: true,","            status: true,","            created_at: true,","            aluno_id: true,","            alunos: {","              select: {","                id: true,","                name: true,","                email: true,","              },","            },","          },","        },","      },","    })","","    // Inscrições Lab (todas)"],"tokenizedAddedLines":[1000197,1000198,9,10,1000199,1000200,1000201,1000202,16,17,1000203,1000204,20,21,1000205,16,17,1000206,1000207,1000208,1000209,27,28,1000210,1000211,31,32,20,21,33,36,3,1000212]},{"originalStartLineNumberOneIndexed":53,"originalEndLineNumberExclusiveOneIndexed":55,"modifiedStartLineNumberOneIndexed":86,"modifiedEndLineNumberExclusiveOneIndexed":87,"addedLines":["    // Status específicos"],"tokenizedAddedLines":[1000213]},{"originalStartLineNumberOneIndexed":60,"originalEndLineNumberExclusiveOneIndexed":70,"modifiedStartLineNumberOneIndexed":92,"modifiedEndLineNumberExclusiveOneIndexed":148,"addedLines":["    const inscricoesAtivas = inscricoesPorStatusData.reduce((acc, item) => {","      const status = String(item.status)","      // Status diferentes de FINALIZADO (2) são considerados ativos","      if (status !== 'TWO' && status !== '2') {","        return acc + item._count","      }","      return acc","    }, 0)","","    const inscricoesFinalizadas = inscricoesPorStatusData.reduce((acc, item) => {","      const status = String(item.status)","      if (status === 'TWO' || status === '2') {","        return acc + item._count","      }","      return acc","    }, 0)","","    // CORRIGIDO: Calcular vagas usando TURMAS ÚNICAS (não somar por inscrição)","    const turmasUnicas = new Map<number, typeof turmas[0]>()","    turmas.forEach((turma) => {","      if (!turmasUnicas.has(turma.id)) {","        turmasUnicas.set(turma.id, turma)","      }","    })","","    // Calcular vagas totais corretamente (sem duplicação)","    const totalVagas = Array.from(turmasUnicas.values()).reduce(","      (acc, turma) => acc + (turma.qtd_vagas_total || 0),","      0","    )","    const totalVagasOcupadas = Array.from(turmasUnicas.values()).reduce(","      (acc, turma) => acc + (turma.qtd_vagas_preenchidas || 0),","      0","    )","    const totalVagasLivres = totalVagas - totalVagasOcupadas","","    // Distribuição por curso (via turma) - SEM duplicação","    const cursosMap = new Map<string, number>()","    turmasUnicas.forEach((turma) => {","      const curso = turma.titulo || 'Sem curso'","      cursosMap.set(curso, (cursosMap.get(curso) || 0) + 1)","    })","","    const distribuicaoPorCurso = Array.from(cursosMap.entries())","      .map(([curso, total]) => ({","        curso,","        total,","      }))","      .sort((a, b) => b.total - a.total)","","    // Normalizar e categorizar cursos","    const cursosCategorizados = categorizarCursos(distribuicaoPorCurso)","","    // Distribuição de INSCRIÇÕES por curso (diferente de turmas)","    const inscricoesPorCursoMap = new Map<string, number>()","    inscricoes.forEach((inscricao) => {"],"tokenizedAddedLines":[1000214,1000215,1000216,1000217,1000218,114,59,1000219,3,1000220,1000215,1000221,1000218,114,59,1000219,3,1000222,1000223,1000224,1000225,1000226,114,36,3,1000227,1000228,1000229,155,88,1000230,1000231,155,88,1000232,3,1000233,1000234,1000235,1000236,1000237,36,3,1000238,62,63,64,65,66,3,1000239,1000240,3,1000241,1000242,116]},{"originalStartLineNumberOneIndexed":71,"originalEndLineNumberExclusiveOneIndexed":74,"modifiedStartLineNumberOneIndexed":149,"modifiedEndLineNumberExclusiveOneIndexed":151,"addedLines":["      inscricoesPorCursoMap.set(curso, (inscricoesPorCursoMap.get(curso) || 0) + 1)","    })"],"tokenizedAddedLines":[1000243,36]},{"originalStartLineNumberOneIndexed":75,"originalEndLineNumberExclusiveOneIndexed":76,"modifiedStartLineNumberOneIndexed":152,"modifiedEndLineNumberExclusiveOneIndexed":153,"addedLines":["    const inscricoesPorCurso = Array.from(inscricoesPorCursoMap.entries())"],"tokenizedAddedLines":[1000244]},{"originalStartLineNumberOneIndexed":82,"originalEndLineNumberExclusiveOneIndexed":82,"modifiedStartLineNumberOneIndexed":159,"modifiedEndLineNumberExclusiveOneIndexed":161,"addedLines":["    const inscricoesPorCursoNormalizado = categorizarCursos(inscricoesPorCurso)",""],"tokenizedAddedLines":[1000245,3]},{"originalStartLineNumberOneIndexed":132,"originalEndLineNumberExclusiveOneIndexed":133,"modifiedStartLineNumberOneIndexed":211,"modifiedEndLineNumberExclusiveOneIndexed":212,"addedLines":["    // Inscrições por laboratório - CORRIGIDO (usar turmas únicas)"],"tokenizedAddedLines":[1000246]},{"originalStartLineNumberOneIndexed":139,"originalEndLineNumberExclusiveOneIndexed":139,"modifiedStartLineNumberOneIndexed":218,"modifiedEndLineNumberExclusiveOneIndexed":219,"addedLines":["        totalTurmas: number"],"tokenizedAddedLines":[1000247]},{"originalStartLineNumberOneIndexed":145,"originalEndLineNumberExclusiveOneIndexed":150,"modifiedStartLineNumberOneIndexed":225,"modifiedEndLineNumberExclusiveOneIndexed":230,"addedLines":["    // Primeiro, processar turmas únicas por laboratório","    turmasUnicas.forEach((turma) => {","      const labNome = turma.laboratorios?.nome || 'Sem laboratório'","      const municipio = turma.laboratorios?.municipio || 'Sem município'","      const curso = turma.titulo || 'Sem curso'"],"tokenizedAddedLines":[1000248,1000235,1000249,1000250,1000236]},{"originalStartLineNumberOneIndexed":156,"originalEndLineNumberExclusiveOneIndexed":156,"modifiedStartLineNumberOneIndexed":236,"modifiedEndLineNumberExclusiveOneIndexed":237,"addedLines":["          totalTurmas: 0,"],"tokenizedAddedLines":[1000251]},{"originalStartLineNumberOneIndexed":163,"originalEndLineNumberExclusiveOneIndexed":164,"modifiedStartLineNumberOneIndexed":244,"modifiedEndLineNumberExclusiveOneIndexed":245,"addedLines":["      lab.totalTurmas++"],"tokenizedAddedLines":[1000252]},{"originalStartLineNumberOneIndexed":165,"originalEndLineNumberExclusiveOneIndexed":167,"modifiedStartLineNumberOneIndexed":246,"modifiedEndLineNumberExclusiveOneIndexed":257,"addedLines":["      lab.vagasOcupadas += turma.qtd_vagas_preenchidas || 0","      lab.vagasTotal += turma.qtd_vagas_total || 0","    })","","    // Depois, contar inscrições por laboratório","    inscricoes.forEach((inscricao) => {","      const labNome = inscricao.turmas?.laboratorios?.nome || 'Sem laboratório'","      const lab = laboratoriosMap.get(labNome)","      if (lab) {","        lab.totalInscricoes++","      }"],"tokenizedAddedLines":[1000253,1000254,36,3,1000255,116,117,1000256,1000257,1000258,114]},{"originalStartLineNumberOneIndexed":174,"originalEndLineNumberExclusiveOneIndexed":174,"modifiedStartLineNumberOneIndexed":264,"modifiedEndLineNumberExclusiveOneIndexed":265,"addedLines":["        totalTurmas: lab.totalTurmas,"],"tokenizedAddedLines":[1000259]},{"originalStartLineNumberOneIndexed":178,"originalEndLineNumberExclusiveOneIndexed":178,"modifiedStartLineNumberOneIndexed":269,"modifiedEndLineNumberExclusiveOneIndexed":270,"addedLines":["        taxaOcupacao: lab.vagasTotal > 0 ? (lab.vagasOcupadas / lab.vagasTotal) * 100 : 0,"],"tokenizedAddedLines":[1000260]},{"originalStartLineNumberOneIndexed":190,"originalEndLineNumberExclusiveOneIndexed":200,"modifiedStartLineNumberOneIndexed":282,"modifiedEndLineNumberExclusiveOneIndexed":310,"addedLines":["    // Análise detalhada por curso","    const analisePorCurso = inscricoesPorCursoNormalizado.cursosNormalizados.map((curso) => {","      // Encontrar turmas deste curso","      const turmasDoCurso = Array.from(turmasUnicas.values()).filter(","        (t) => t.titulo === curso.nomeOriginal","      )","      ","      const totalTurmas = turmasDoCurso.length","      const totalVagasCurso = turmasDoCurso.reduce(","        (acc, t) => acc + (t.qtd_vagas_total || 0),","        0","      )","      const vagasOcupadasCurso = turmasDoCurso.reduce(","        (acc, t) => acc + (t.qtd_vagas_preenchidas || 0),","        0","      )","      const vagasLivresCurso = totalVagasCurso - vagasOcupadasCurso","      ","      return {","        ...curso,","        totalTurmas,","        totalVagas: totalVagasCurso,","        vagasOcupadas: vagasOcupadasCurso,","        vagasLivres: vagasLivresCurso,","        taxaOcupacao: totalVagasCurso > 0 ? (vagasOcupadasCurso / totalVagasCurso) * 100 : 0,","        totalInscricoes: curso.total,","      }","    })"],"tokenizedAddedLines":[1000261,1000262,1000263,1000264,1000265,1000266,1000267,1000268,1000269,1000270,1000271,1000266,1000272,1000273,1000271,1000266,1000274,1000267,1000275,1000276,1000277,1000278,1000279,1000280,1000281,1000282,114,36]},{"originalStartLineNumberOneIndexed":227,"originalEndLineNumberExclusiveOneIndexed":229,"modifiedStartLineNumberOneIndexed":337,"modifiedEndLineNumberExclusiveOneIndexed":353,"addedLines":["          totalTurmas: turmasUnicas.size,","          // Análise adicional","          explicacao: {","            vagasCalculo: 'As vagas são calculadas usando TURMAS ÚNICAS, não por inscrição. Cada turma conta suas vagas apenas uma vez, evitando duplicação.',","            inscricoesCalculo: 'As inscrições são contadas individualmente. Um aluno pode se inscrever em múltiplas turmas.',","            diferenca: totalInscricoes - turmasUnicas.size > 0 ","              ? `${totalInscricoes - turmasUnicas.size} inscrições a mais que turmas (múltiplos alunos por turma)`","              : 'Número de inscrições e turmas balanceados',","          },","        },","        distribuicaoPorCurso: distribuicaoPorCurso,","        cursosNormalizados: cursosCategorizados.cursosNormalizados,","        cursosPorCategoria: cursosCategorizados.porCategoria,","        cursosPorSubcategoria: cursosCategorizados.porSubcategoria,","        inscricoesPorCursoNormalizado: inscricoesPorCursoNormalizado.cursosNormalizados,","        analisePorCurso: analisePorCurso,"],"tokenizedAddedLines":[1000283,1000284,1000285,1000286,1000287,1000288,1000289,1000290,20,21,1000291,1000292,1000293,1000294,1000295,1000296]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}
{"fsPath":"\\home\\oxetech_mcz\\docs\\SOLUCAO_UNAUTHORIZED.md","fileUuid":"7da1631e-54ef-46d9-9e07-5f3bbfd8db91","fileSizeBytes":3009,"numLines":96,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":97,"addedLines":["# Solu√ß√£o para Erro Unauthorized","","## ‚úÖ Corre√ß√µes Aplicadas","","### 1. **Fluxo de Login Corrigido** (`app/login/page.tsx`)","   - ‚úÖ Removida verifica√ß√£o de cookie via JavaScript (HttpOnly n√£o √© acess√≠vel)","   - ‚úÖ Usado `window.location.href` para for√ßar reload completo","   - ‚úÖ Delay de 300ms para garantir processamento do cookie","   - ‚úÖ Confian√ßa na resposta do servidor (se login OK, cookie foi setado)","","### 2. **Tratamento de Erros Melhorado**","   - ‚úÖ P√°ginas BI detectam erro 401","   - ‚úÖ Mensagem espec√≠fica para erro de autentica√ß√£o","   - ‚úÖ Link direto para p√°gina de login","   - ‚úÖ Logs detalhados no middleware","","### 3. **Middleware com Logs**","   - ‚úÖ Log de erros de JWT para debug","   - ‚úÖ Mensagens de erro mais descritivas","","## üîß Como Resolver","","### **Passo 1: Fazer Login**","1. Acesse `/login`","2. Use as credenciais de teste:","   - **Admin**: `admin@oxetech.al.gov.br` / `admin123`","   - **Gestor**: `gestor@oxetech.al.gov.br` / `gestor123`","   - **Visualiza√ß√£o**: `visualizacao@oxetech.al.gov.br` / `view123`","","### **Passo 2: Verificar se Cookie foi Setado**","1. Ap√≥s login, abra DevTools (F12)","2. V√° em **Application** ‚Üí **Cookies** ‚Üí `http://localhost:3000`","3. Procure por `oxetech-auth-token`","4. Se n√£o existir:","   - Fa√ßa logout (limpe cookies)","   - Fa√ßa login novamente","   - Verifique se n√£o h√° bloqueadores de cookies","","### **Passo 3: Verificar Requisi√ß√µes**","1. DevTools ‚Üí **Network**","2. Acesse `/bi/lab`","3. Procure pela requisi√ß√£o `/api/bi/lab-detalhado`","4. Verifique:","   - **Request Headers** ‚Üí **Cookie**: Deve conter `oxetech-auth-token=...`","   - **Response**: Status deve ser 200 (n√£o 401)","","### **Passo 4: Se Token Expirou**","- Tokens expiram em 8 horas","- Se expirou, fa√ßa login novamente","","## üîç Debug","","### **Verificar se Cookie est√° Sendo Enviado:**","```javascript","// No console do navegador (depois de fazer login)","fetch('/api/bi/lab-detalhado', { credentials: 'include' })","  .then(r => r.json())","  .then(console.log)","  .catch(console.error)","```","","### **Verificar Token no Servidor:**","- Olhar logs do terminal onde `npm run dev` est√° rodando","- Procurar por: `JWT verification error:`","- Se houver erro, o token pode estar inv√°lido ou expirado","","### **Verificar Middleware:**","- Logs do middleware mostram:","  - Status da requisi√ß√£o","  - Se cookie foi encontrado","  - Se token foi verificado com sucesso","","## üìã Checklist de Verifica√ß√£o","","- [ ] Fez login com credenciais corretas?","- [ ] Cookie `oxetech-auth-token` existe no DevTools?","- [ ] Cookie est√° sendo enviado nas requisi√ß√µes (Network tab)?","- [ ] Status da resposta √© 200 (n√£o 401)?","- [ ] Token n√£o expirou (fazer login h√° menos de 8 horas)?","","## ‚úÖ Status das Corre√ß√µes","","- ‚úÖ Login corrigido com reload completo","- ‚úÖ Tratamento de erros melhorado","- ‚úÖ Mensagens claras para usu√°rio","- ‚úÖ Link para login em caso de erro","- ‚úÖ Logs detalhados para debug","","---","","**Importante**: ","- Cookie HttpOnly **n√£o** √© acess√≠vel via JavaScript","- Por isso, usamos `window.location.href` para for√ßar reload completo","- Isso garante que o cookie seja processado corretamente pelo navegador","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000001,1000003,1000004,1000005,1000006,1000007,1000001,1000008,1000009,1000010,1000011,1000012,1000001,1000013,1000014,1000015,1000001,1000016,1000001,1000017,1000018,1000019,1000020,1000021,1000022,1000001,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000001,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000001,1000038,1000039,1000040,1000001,1000041,1000001,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000001,1000050,1000051,1000052,1000053,1000001,1000054,1000055,1000056,1000057,1000058,1000001,1000059,1000001,1000060,1000061,1000062,1000063,1000064,1000001,1000065,1000001,1000066,1000067,1000068,1000069,1000070,1000001,1000071,1000001,1000072,1000073,1000074,1000075,1000001,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}
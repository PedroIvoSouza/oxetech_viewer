{"fsPath":"\\home\\oxetech_mcz\\app\\api\\lab\\route.ts","fileUuid":"103e0709-1d36-452a-b0d8-f6f5faf7c8f2","fileSizeBytes":14266,"numLines":428,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":8,"addedLines":["/**"," * API de Dados do Lab"," * "," * Retorna dados agregados do CSV legado + banco de dados,"," * apresentando como uma coisa só, sem diferenciar fontes."," */",""],"tokenizedAddedLines":[1000311,1000312,1000313,1000314,1000315,1000316,4]},{"originalStartLineNumberOneIndexed":4,"originalEndLineNumberExclusiveOneIndexed":4,"modifiedStartLineNumberOneIndexed":11,"modifiedEndLineNumberExclusiveOneIndexed":12,"addedLines":["import { agregarDadosLab } from '@/lib/data-aggregator/lab-aggregator'"],"tokenizedAddedLines":[1000317]},{"originalStartLineNumberOneIndexed":9,"originalEndLineNumberExclusiveOneIndexed":42,"modifiedStartLineNumberOneIndexed":17,"modifiedEndLineNumberExclusiveOneIndexed":21,"addedLines":["    // Carregar dados agregados (CSV + Banco) - apresentado como uma coisa só","    const turmasAgregadas = await agregarDadosLab(true) // Usar IA para corrigir nomes","","    // Buscar inscrições do banco para dados detalhados de alunos"],"tokenizedAddedLines":[1000318,1000319,4,1000320]},{"originalStartLineNumberOneIndexed":79,"originalEndLineNumberExclusiveOneIndexed":89,"modifiedStartLineNumberOneIndexed":58,"modifiedEndLineNumberExclusiveOneIndexed":67,"addedLines":["    // Estatísticas gerais baseadas em dados agregados","    const totalTurmas = turmasAgregadas.length","    const totalVagas = turmasAgregadas.reduce((acc, t) => acc + t.qtdVagasTotal, 0)","    const vagasOcupadas = turmasAgregadas.reduce((acc, t) => acc + t.qtdVagasPreenchidas, 0)","    const vagasLivres = totalVagas - vagasOcupadas","    const totalInscricoes = inscricoes.length","    const totalCertificadosLab = turmasAgregadas.reduce((acc, t) => acc + t.numFormados, 0)","","    // Status de inscrições (do banco)"],"tokenizedAddedLines":[1000321,1000322,1000323,1000324,1000325,1000326,1000327,4,1000328]},{"originalStartLineNumberOneIndexed":96,"originalEndLineNumberExclusiveOneIndexed":97,"modifiedStartLineNumberOneIndexed":74,"modifiedEndLineNumberExclusiveOneIndexed":74},{"originalStartLineNumberOneIndexed":103,"originalEndLineNumberExclusiveOneIndexed":111,"modifiedStartLineNumberOneIndexed":80,"modifiedEndLineNumberExclusiveOneIndexed":80},{"originalStartLineNumberOneIndexed":119,"originalEndLineNumberExclusiveOneIndexed":139,"modifiedStartLineNumberOneIndexed":88,"modifiedEndLineNumberExclusiveOneIndexed":89,"addedLines":["    // Distribuição por curso (usando turmas agregadas)"],"tokenizedAddedLines":[1000329]},{"originalStartLineNumberOneIndexed":140,"originalEndLineNumberExclusiveOneIndexed":141,"modifiedStartLineNumberOneIndexed":90,"modifiedEndLineNumberExclusiveOneIndexed":91,"addedLines":["    turmasAgregadas.forEach((turma) => {"],"tokenizedAddedLines":[1000330]},{"originalStartLineNumberOneIndexed":155,"originalEndLineNumberExclusiveOneIndexed":156,"modifiedStartLineNumberOneIndexed":105,"modifiedEndLineNumberExclusiveOneIndexed":106,"addedLines":["    // Distribuição de INSCRIÇÕES por curso (do banco)"],"tokenizedAddedLines":[1000331]},{"originalStartLineNumberOneIndexed":171,"originalEndLineNumberExclusiveOneIndexed":172,"modifiedStartLineNumberOneIndexed":121,"modifiedEndLineNumberExclusiveOneIndexed":122,"addedLines":["    // Evolução temporal mensal (inscrições do banco)"],"tokenizedAddedLines":[1000332]},{"originalStartLineNumberOneIndexed":221,"originalEndLineNumberExclusiveOneIndexed":222,"modifiedStartLineNumberOneIndexed":171,"modifiedEndLineNumberExclusiveOneIndexed":172,"addedLines":["    // Inscrições por laboratório (usando turmas agregadas)"],"tokenizedAddedLines":[1000333]},{"originalStartLineNumberOneIndexed":235,"originalEndLineNumberExclusiveOneIndexed":239,"modifiedStartLineNumberOneIndexed":185,"modifiedEndLineNumberExclusiveOneIndexed":188,"addedLines":["    // Processar turmas agregadas por laboratório","    turmasAgregadas.forEach((turma) => {","      const labNome = turma.laboratorio || 'Sem laboratório'"],"tokenizedAddedLines":[1000334,1000330,1000335]},{"originalStartLineNumberOneIndexed":244,"originalEndLineNumberExclusiveOneIndexed":245,"modifiedStartLineNumberOneIndexed":193,"modifiedEndLineNumberExclusiveOneIndexed":194,"addedLines":["          municipio: '', // Buscar do banco se necessário"],"tokenizedAddedLines":[1000336]},{"originalStartLineNumberOneIndexed":256,"originalEndLineNumberExclusiveOneIndexed":261,"modifiedStartLineNumberOneIndexed":205,"modifiedEndLineNumberExclusiveOneIndexed":225,"addedLines":["      lab.vagasOcupadas += turma.qtdVagasPreenchidas","      lab.vagasTotal += turma.qtdVagasTotal","    })","","    // Buscar municípios dos laboratórios do banco","    const laboratoriosBanco = await prisma.laboratorios.findMany({","      select: {","        nome: true,","        municipio: true,","      },","    })","","    laboratoriosBanco.forEach((labBanco) => {","      const lab = laboratoriosMap.get(labBanco.nome)","      if (lab) {","        lab.municipio = labBanco.municipio","      }","    })","","    // Contar inscrições por laboratório (do banco)"],"tokenizedAddedLines":[1000337,1000338,34,4,1000339,1000340,10,1000341,1000342,33,34,4,1000343,1000344,184,1000345,71,34,4,1000346]},{"originalStartLineNumberOneIndexed":266,"originalEndLineNumberExclusiveOneIndexed":266,"modifiedStartLineNumberOneIndexed":230,"modifiedEndLineNumberExclusiveOneIndexed":241,"addedLines":["      } else {","        // Criar entrada se não existir","        laboratoriosMap.set(labNome, {","          nome: labNome,","          municipio: inscricao.turmas?.laboratorios?.municipio || '',","          totalInscricoes: 1,","          totalTurmas: 0,","          cursos: new Set(),","          vagasOcupadas: 0,","          vagasTotal: 0,","        })"],"tokenizedAddedLines":[1000347,1000348,167,168,1000349,1000350,171,172,173,174,175]},{"originalStartLineNumberOneIndexed":292,"originalEndLineNumberExclusiveOneIndexed":303,"modifiedStartLineNumberOneIndexed":267,"modifiedEndLineNumberExclusiveOneIndexed":283,"addedLines":["    // Análise detalhada por curso normalizado (usando turmas agregadas)","    interface TurmaAgregada {","      titulo: string","      cursoNormalizado: string","      laboratorio: string","      qtdVagasTotal: number","      qtdVagasPreenchidas: number","      numFormados: number","    }","    const turmasNormalizadasMap = new Map<string, TurmaAgregada[]>()","    turmasAgregadas.forEach((turma) => {","      const normalizado = turma.cursoNormalizado.toLowerCase().trim()","      if (!turmasNormalizadasMap.has(normalizado)) {","        turmasNormalizadasMap.set(normalizado, [])","      }","      turmasNormalizadasMap.get(normalizado)!.push(turma)"],"tokenizedAddedLines":[1000351,1000352,1000353,1000354,1000355,1000356,1000357,1000358,150,1000359,1000330,1000360,1000361,1000362,71,1000363]},{"originalStartLineNumberOneIndexed":306,"originalEndLineNumberExclusiveOneIndexed":307,"modifiedStartLineNumberOneIndexed":286,"modifiedEndLineNumberExclusiveOneIndexed":286},{"originalStartLineNumberOneIndexed":311,"originalEndLineNumberExclusiveOneIndexed":319,"modifiedStartLineNumberOneIndexed":290,"modifiedEndLineNumberExclusiveOneIndexed":292,"addedLines":["      const totalVagasCurso = turmasDoCurso.reduce((acc, t) => acc + t.qtdVagasTotal, 0)","      const vagasOcupadasCurso = turmasDoCurso.reduce((acc, t) => acc + t.qtdVagasPreenchidas, 0)"],"tokenizedAddedLines":[1000364,1000365]},{"originalStartLineNumberOneIndexed":332,"originalEndLineNumberExclusiveOneIndexed":333,"modifiedStartLineNumberOneIndexed":305,"modifiedEndLineNumberExclusiveOneIndexed":306,"addedLines":["    // Lista detalhada de inscrições (do banco)"],"tokenizedAddedLines":[1000366]},{"originalStartLineNumberOneIndexed":344,"originalEndLineNumberExclusiveOneIndexed":346,"modifiedStartLineNumberOneIndexed":317,"modifiedEndLineNumberExclusiveOneIndexed":319,"addedLines":["    // Alunos Certificados do Lab (usando dados agregados + banco)","    // Buscar do banco para dados detalhados, mas usar total de formados agregados"],"tokenizedAddedLines":[1000367,1000368]},{"originalStartLineNumberOneIndexed":413,"originalEndLineNumberExclusiveOneIndexed":414,"modifiedStartLineNumberOneIndexed":386,"modifiedEndLineNumberExclusiveOneIndexed":387,"addedLines":["          inscricoesPorStatus: inscricoesPorStatusData.map((item) => ({"],"tokenizedAddedLines":[1000369]},{"originalStartLineNumberOneIndexed":419,"originalEndLineNumberExclusiveOneIndexed":423,"modifiedStartLineNumberOneIndexed":392,"modifiedEndLineNumberExclusiveOneIndexed":396,"addedLines":["          vagasOcupadas,","          vagasLivres,","          totalTurmas,","          // Explicação sobre cálculo (sem mencionar CSV/Banco)"],"tokenizedAddedLines":[1000370,1000371,1000372,1000373]},{"originalStartLineNumberOneIndexed":424,"originalEndLineNumberExclusiveOneIndexed":425,"modifiedStartLineNumberOneIndexed":397,"modifiedEndLineNumberExclusiveOneIndexed":398,"addedLines":["            vagasCalculo: 'As vagas são calculadas usando turmas únicas, evitando duplicação.',"],"tokenizedAddedLines":[1000374]},{"originalStartLineNumberOneIndexed":426,"originalEndLineNumberExclusiveOneIndexed":428,"modifiedStartLineNumberOneIndexed":399,"modifiedEndLineNumberExclusiveOneIndexed":401,"addedLines":["            diferenca: totalInscricoes - totalTurmas > 0","              ? `${totalInscricoes - totalTurmas} inscrições a mais que turmas (múltiplos alunos por turma)`"],"tokenizedAddedLines":[1000375,1000376]},{"originalStartLineNumberOneIndexed":441,"originalEndLineNumberExclusiveOneIndexed":442,"modifiedStartLineNumberOneIndexed":414,"modifiedEndLineNumberExclusiveOneIndexed":415,"addedLines":["        // Total de certificados usa dados agregados (mais completo)"],"tokenizedAddedLines":[1000377]},{"originalStartLineNumberOneIndexed":443,"originalEndLineNumberExclusiveOneIndexed":444,"modifiedStartLineNumberOneIndexed":416,"modifiedEndLineNumberExclusiveOneIndexed":417,"addedLines":["        totalCertificadosLab: totalCertificadosLab, // Total agregado (CSV + Banco)"],"tokenizedAddedLines":[1000378]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}
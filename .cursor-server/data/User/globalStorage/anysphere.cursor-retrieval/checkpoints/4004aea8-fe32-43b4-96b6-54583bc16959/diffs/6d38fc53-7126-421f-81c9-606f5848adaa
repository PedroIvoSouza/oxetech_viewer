{"fsPath":"\\home\\oxetech_mcz\\app\\api\\trilhas\\route.ts","fileUuid":"6d38fc53-7126-421f-81c9-606f5848adaa","fileSizeBytes":8765,"numLines":320,"diffChanges":[{"originalStartLineNumberOneIndexed":6,"originalEndLineNumberExclusiveOneIndexed":8,"modifiedStartLineNumberOneIndexed":6,"modifiedEndLineNumberExclusiveOneIndexed":25,"addedLines":["export async function GET(request: Request) {","  try {","    const { searchParams } = new URL(request.url)","    const periodo = searchParams.get('periodo') || 'all'","    const busca = searchParams.get('busca') || ''","","    // Calcular período","    let dataInicio: Date | undefined","    if (periodo === '30d') {","      dataInicio = new Date()","      dataInicio.setDate(dataInicio.getDate() - 30)","    } else if (periodo === '90d') {","      dataInicio = new Date()","      dataInicio.setMonth(dataInicio.getMonth() - 3)","    } else if (periodo === '1y') {","      dataInicio = new Date()","      dataInicio.setFullYear(dataInicio.getFullYear() - 1)","    }",""],"tokenizedAddedLines":[1000115,6,1000116,1000117,1000118,3,1000119,1000120,1000121,1000122,1000123,1000124,1000122,1000125,1000126,1000122,1000127,1000128,3]},{"originalStartLineNumberOneIndexed":10,"originalEndLineNumberExclusiveOneIndexed":10,"modifiedStartLineNumberOneIndexed":27,"modifiedEndLineNumberExclusiveOneIndexed":35,"addedLines":["      where: {","        ...(busca && {","          titulo: {","            contains: busca,","            mode: 'insensitive' as any,","          },","        }),","      },"],"tokenizedAddedLines":[1000129,1000130,1000131,1000132,1000133,28,1000134,30]},{"originalStartLineNumberOneIndexed":16,"originalEndLineNumberExclusiveOneIndexed":16,"modifiedStartLineNumberOneIndexed":41,"modifiedEndLineNumberExclusiveOneIndexed":42,"addedLines":["        updated_at: true,"],"tokenizedAddedLines":[1000135]},{"originalStartLineNumberOneIndexed":41,"originalEndLineNumberExclusiveOneIndexed":43,"modifiedStartLineNumberOneIndexed":67,"modifiedEndLineNumberExclusiveOneIndexed":78,"addedLines":["    // Inscrições com filtro de período","    const inscricoesWhere: any = {}","    if (dataInicio) {","      inscricoesWhere.created_at = {","        gte: dataInicio,","      }","    }","","    const [inscricoes, inscricoesTotal] = await Promise.all([","      prisma.inscricoes_trilhas_alunos.findMany({","        where: inscricoesWhere,"],"tokenizedAddedLines":[1000136,1000137,1000138,1000139,1000140,67,1000128,3,1000141,1000142,1000143]},{"originalStartLineNumberOneIndexed":44,"originalEndLineNumberExclusiveOneIndexed":44,"modifiedStartLineNumberOneIndexed":79,"modifiedEndLineNumberExclusiveOneIndexed":80,"addedLines":["          id: true,"],"tokenizedAddedLines":[72]},{"originalStartLineNumberOneIndexed":46,"originalEndLineNumberExclusiveOneIndexed":46,"modifiedStartLineNumberOneIndexed":82,"modifiedEndLineNumberExclusiveOneIndexed":83,"addedLines":["          created_at: true,"],"tokenizedAddedLines":[1000144]},{"originalStartLineNumberOneIndexed":55,"originalEndLineNumberExclusiveOneIndexed":55,"modifiedStartLineNumberOneIndexed":92,"modifiedEndLineNumberExclusiveOneIndexed":147,"addedLines":["            },","          },","        },","      }),","      prisma.inscricoes_trilhas_alunos.count(),","    ])","","    // Evolução temporal de inscrições (últimos 12 meses)","    const dozeMesesAtras = new Date()","    dozeMesesAtras.setMonth(dozeMesesAtras.getMonth() - 12)","","    const inscricoesTemporal = await prisma.inscricoes_trilhas_alunos.findMany({","      where: {","        created_at: {","          gte: dozeMesesAtras,","        },","      },","      select: {","        created_at: true,","      },","      orderBy: {","        created_at: 'asc',","      },","    })","","    const evolucaoTemporal = []","    for (let i = 11; i >= 0; i--) {","      const mes = new Date()","      mes.setMonth(mes.getMonth() - i)","","      const inicioMes = new Date(mes.getFullYear(), mes.getMonth(), 1)","      const fimMes = new Date(mes.getFullYear(), mes.getMonth() + 1, 0)","","      const total = inscricoesTemporal.filter((insc) => {","        const data = new Date(insc.created_at)","        return data >= inicioMes && data <= fimMes","      }).length","","      evolucaoTemporal.push({","        mes: mes.toLocaleDateString('pt-BR', {","          month: 'short',","          year: 'numeric',","        }),","        inscricoes: total,","      })","    }","","    // Progresso médio dos alunos por trilha","    const trilhasComModulos = await prisma.trilhas_de_conhecimento.findMany({","      select: {","        id: true,","        titulo: true,","        modulos_trilhas: {","          select: {","            id: true,"],"tokenizedAddedLines":[25,28,29,1000145,1000146,1000147,3,1000148,1000149,1000150,3,1000151,1000129,1000152,1000153,29,30,9,14,30,31,1000154,30,33,3,1000155,1000156,1000157,1000158,3,1000159,1000160,3,1000161,1000162,1000163,1000164,3,1000165,1000166,1000167,1000168,1000134,1000169,1000170,1000128,3,34,87,9,10,11,15,16,17]},{"originalStartLineNumberOneIndexed":82,"originalEndLineNumberExclusiveOneIndexed":82,"modifiedStartLineNumberOneIndexed":174,"modifiedEndLineNumberExclusiveOneIndexed":175,"addedLines":["        id: trilha.id,"],"tokenizedAddedLines":[1000171]},{"originalStartLineNumberOneIndexed":86,"originalEndLineNumberExclusiveOneIndexed":90,"modifiedStartLineNumberOneIndexed":179,"modifiedEndLineNumberExclusiveOneIndexed":223,"addedLines":["        percentualConclusao:","          totalInscritos > 0 ? (concluidos / totalInscritos) * 100 : 0,","        totalModulos: trilha.modulos_trilhas.length,","        status: totalInscritos > 0 ? 'ativo' : 'inativo',","      }","    })","","    // Top 10 trilhas mais acessadas","    const topTrilhas = progressoPorTrilha","      .sort((a, b) => b.totalInscritos - a.totalInscritos)","      .slice(0, 10)","","    // Conclusão média por módulo (geral)","    const todasInscricoes = await prisma.inscricoes_trilhas_alunos.findMany({","      select: {","        modulos_trilhas_alunos: {","          select: {","            curso_concluido: true,","            atividade_concluida: true,","          },","        },","      },","    })","","    const modulosConcluidos = todasInscricoes.reduce((acc, insc) => {","      return (","        acc +","        insc.modulos_trilhas_alunos.filter(","          (m) => m.curso_concluido && m.atividade_concluida","        ).length","      )","    }, 0)","","    const totalModulosAtividades = todasInscricoes.reduce(","      (acc, insc) => acc + insc.modulos_trilhas_alunos.length,","      0","    )","","    const conclusaoMediaModulo =","      totalModulosAtividades > 0","        ? (modulosConcluidos / totalModulosAtividades) * 100","        : 0","","    // Tabela de inscritos detalhada"],"tokenizedAddedLines":[1000172,1000173,1000174,1000175,67,33,3,1000176,1000177,1000178,1000179,3,1000180,1000181,9,40,16,41,42,28,29,30,33,3,1000182,1000183,1000184,1000185,1000186,1000187,46,1000188,3,1000189,1000190,1000191,86,3,1000192,1000193,1000194,1000195,3,1000196]},{"originalStartLineNumberOneIndexed":95,"originalEndLineNumberExclusiveOneIndexed":95,"modifiedStartLineNumberOneIndexed":228,"modifiedEndLineNumberExclusiveOneIndexed":229,"addedLines":["          trilha_id: true,"],"tokenizedAddedLines":[1000197]},{"originalStartLineNumberOneIndexed":96,"originalEndLineNumberExclusiveOneIndexed":96,"modifiedStartLineNumberOneIndexed":230,"modifiedEndLineNumberExclusiveOneIndexed":231,"addedLines":["          created_at: true,"],"tokenizedAddedLines":[1000144]},{"originalStartLineNumberOneIndexed":116,"originalEndLineNumberExclusiveOneIndexed":129,"modifiedStartLineNumberOneIndexed":251,"modifiedEndLineNumberExclusiveOneIndexed":256,"addedLines":["        orderBy: {","          created_at: 'desc',","        },","      }","    )"],"tokenizedAddedLines":[1000198,1000199,29,67,86]},{"originalStartLineNumberOneIndexed":135,"originalEndLineNumberExclusiveOneIndexed":136,"modifiedStartLineNumberOneIndexed":262,"modifiedEndLineNumberExclusiveOneIndexed":262},{"originalStartLineNumberOneIndexed":139,"originalEndLineNumberExclusiveOneIndexed":140,"modifiedStartLineNumberOneIndexed":265,"modifiedEndLineNumberExclusiveOneIndexed":266,"addedLines":["      const totalModulos = trilhaModulos?.modulos_trilhas.length || 0"],"tokenizedAddedLines":[1000200]},{"originalStartLineNumberOneIndexed":150,"originalEndLineNumberExclusiveOneIndexed":153,"modifiedStartLineNumberOneIndexed":276,"modifiedEndLineNumberExclusiveOneIndexed":295,"addedLines":["        dataInscricao: inscricao.created_at,","      }","    })","","    // Estatísticas gerais","    const totalTrilhas = trilhas.length","    const totalInscritos = inscricoesTotal","    const totalConcluidos = await prisma.inscricoes_trilhas_alunos.count({","      where: { concluido: true },","    })","","    const progressoMedioGeral =","      progressoPorTrilha.length > 0","        ? progressoPorTrilha.reduce(","            (acc, item) => acc + item.progressoMedio,","            0","          ) / progressoPorTrilha.length","        : 0",""],"tokenizedAddedLines":[1000201,67,33,3,1000202,1000203,1000204,1000205,1000206,33,3,1000207,1000208,1000209,1000210,1000211,1000212,1000195,3]},{"originalStartLineNumberOneIndexed":154,"originalEndLineNumberExclusiveOneIndexed":154,"modifiedStartLineNumberOneIndexed":296,"modifiedEndLineNumberExclusiveOneIndexed":304,"addedLines":["      data: {","        stats: {","          totalTrilhas,","          totalInscritos,","          totalConcluidos,","          progressoMedioGeral,","          conclusaoMediaModulo,","        },"],"tokenizedAddedLines":[1000213,1000214,1000215,1000216,1000217,1000218,1000219,29]},{"originalStartLineNumberOneIndexed":156,"originalEndLineNumberExclusiveOneIndexed":156,"modifiedStartLineNumberOneIndexed":306,"modifiedEndLineNumberExclusiveOneIndexed":308,"addedLines":["        topTrilhas,","        evolucaoTemporal,"],"tokenizedAddedLines":[1000220,1000221]},{"originalStartLineNumberOneIndexed":157,"originalEndLineNumberExclusiveOneIndexed":157,"modifiedStartLineNumberOneIndexed":309,"modifiedEndLineNumberExclusiveOneIndexed":311,"addedLines":["      },","      error: null,"],"tokenizedAddedLines":[30,1000222]},{"originalStartLineNumberOneIndexed":161,"originalEndLineNumberExclusiveOneIndexed":162,"modifiedStartLineNumberOneIndexed":315,"modifiedEndLineNumberExclusiveOneIndexed":316,"addedLines":["      { data: null, error: 'Failed to fetch trilhas data' },"],"tokenizedAddedLines":[1000223]},{"originalStartLineNumberOneIndexed":166,"originalEndLineNumberExclusiveOneIndexed":167,"modifiedStartLineNumberOneIndexed":320,"modifiedEndLineNumberExclusiveOneIndexed":320}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}